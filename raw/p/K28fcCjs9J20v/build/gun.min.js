(function(y,F){"object"===typeof exports&&"undefined"!==typeof module?F(exports):"function"===typeof define&&define.amd?define(["exports"],F):(y=y||self,F(y.GUN={}))})(this,function(y){function F(){Ammo.btTransform.prototype=Object.assign(Object.create(Ammo.btTransform.prototype),{identity:function(){this.setIdentity();return this},positionFromArray:function(a,b,c){b=b||0;a=f.vector3().fromArray(a,b,c);this.setOrigin(a);a.free();return this},eulerFromArray:function(a,b){b=b||0;a=f.quaternion().setFromEuler(a,
b);this.setRotation(a);a.free();return this},eulerFromArrayZYX:function(a,b){b=b||0;this.getBasis().setEulerZYX(a[b],a[b+1],a[b+2]);return this},getRow:function(a){return this.getBasis().getRow(a)},makeRotationDir:function(a){a=f.vector3().fromArray(a);var b=f.vector3(0,1,0),c=f.vector3().cross(b,a).normalize(),e=f.vector3().cross(a,c).normalize(),p=f.matrix3(),d=p.setV3(c,e,a).toQuaternion().normalize();this.setRotation(d);p.free();d.free();a.free();b.free();c.free();e.free()},setFromDirection:function(a){a=
f.vector3().fromArray(a);var b=f.vector3(),c=f.quaternion();if(.99999<a.y())c.set(0,0,0,1);else if(-.99999>a.y())c.set(1,0,0,0);else{b.set(a.z(),0,-a.x());var e=Math.acos(a.y());c.setFromAxisAngle(b.toArray(),e)}this.setRotation(c);a.free();b.free();c.free();return this},quartenionFromAxis:function(a){a=f.quaternion().setFromAxis(a);this.setRotation(a);a.free();return this},quartenionFromAxisAngle:function(a,b){a=f.quaternion().setFromAxisAngle(a,b);this.setRotation(a);a.free();return this},quaternionFromArray:function(a,
b){b=b||0;a=f.quaternion().fromArray(a,b);this.setRotation(a);a.free();return this},fromArray:function(a,b,c){b=b||0;this.positionFromArray(a,b,c);3<a.length&&this.quaternionFromArray(a,b+3);return this},toArray:function(a,b,c){b=b||0;this.getOrigin().toArray(a,b,c);this.getRotation().toArray(a,b+3)},getInverse:function(){var a=f.transform();a.setIdentity();var b=this.getRotation().toMatrix3().transpose(),c=this.getOrigin().clone().negate(),e=b.multiplyByVector3(c),p=b.toQuaternion();a.setOrigin(e);
a.setRotation(p);c.free();e.free();p.free();b.free();return a},multiply:function(a){var b=this.getRotation().toMatrix3(),c=a.getRotation().toMatrix3(),e=this.getOrigin().clone();a=a.getOrigin().clone();var p=b.multiplyByVector3(a).add(e);this.setOrigin(p);b.multiply(c);var d=b.toQuaternion();this.setRotation(d);b.free();c.free();e.free();a.free();d.free();p.free();return this},clone:function(){var a=f.transform();a.setIdentity();a.setOrigin(this.getOrigin());a.setRotation(this.getRotation());return a},
copy:function(a){this.setOrigin(a.getOrigin());this.setRotation(a.getRotation());return this},free:function(){f.freeTransform(this)}});Ammo.btVector3.prototype=Object.assign(Object.create(Ammo.btVector3.prototype),{set:function(a,b,c){this.setValue(a,b,c);return this},zero:function(){this.setValue(0,0,0);return this},negate:function(){this.setValue(-this.x(),-this.y(),-this.z());return this},add:function(a){this.setValue(this.x()+a.x(),this.y()+a.y(),this.z()+a.z());return this},sub:function(a){this.setValue(this.x()-
a.x(),this.y()-a.y(),this.z()-a.z());return this},dot:function(a){return this.x()*a.x()+this.y()*a.y()+this.z()*a.z()},cross:function(a,b){var c=a.x(),e=a.y();a=a.z();var p=b.x(),d=b.y();b=b.z();this.set(e*b-a*d,a*p-c*b,c*d-e*p);return this},multiplyScalar:function(a){this.setValue(this.x()*a,this.y()*a,this.z()*a);return this},multiplyArray:function(a){this.setValue(this.x()*a[0],this.y()*a[1],this.z()*a[2]);return this},fromArray:function(a,b,c){b=b||0;c=c||1;this.setValue(a[b]*c,a[b+1]*c,a[b+2]*
c);return this},divideScalar:function(a){return this.multiplyScalar(1/a)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z())},normalize:function(){return this.divideScalar(this.length()||1)},toArray:function(a,b,c){void 0===a&&(a=[]);void 0===b&&(b=0);c=c||1;a[b]=this.x()*c;a[b+1]=this.y()*c;a[b+2]=this.z()*c;return a},direction:function(a){var b=a.x(),c=a.y(),e=a.z();a=a.w();var p=this.x(),d=this.y(),f=this.z(),g=a*p+c*f-e*d,r=a*d+e*p-b*f,u=a*f+b*d-c*p;p=-b*
p-c*d-e*f;this.setValue(g*a+p*-b+r*-e-u*-c,r*a+p*-c+u*-b-g*-e,u*a+p*-e+g*-c-r*-b);return this},clone:function(){return f.vector3().set(this.x(),this.y(),this.z())},free:function(){f.freeVector3(this)}});Ammo.btQuaternion.prototype=Object.assign(Object.create(Ammo.btQuaternion.prototype),{set:function(a,b,c,e){this.setValue(a,b,c,e);return this},fromArray:function(a,b){void 0===b&&(b=0);this.setValue(a[b],a[b+1],a[b+2],a[b+3]);return this},toArray:function(a,b){void 0===a&&(a=[]);void 0===b&&(b=0);
a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z();a[b+3]=this.w();return a},setFromAxis:function(a){.99999<a[2]?this.setValue(0,0,0,1):-.99999>a[2]?this.setValue(1,0,0,0):this.setFromAxisAngle([a[1],a[0],0],Math.acos(a[2]));return this},setFromAxisAngle:function(a,b){b*=.5;var c=Math.sin(b);this.setValue(a[0]*c,a[1]*c,a[2]*c,Math.cos(b));return this},setFromEuler:function(a){var b=a[0],c=a[1],e=a[2];a=a[3]||"XYZ";var d=Math.cos,f=Math.sin,n=d(.5*b),g=d(.5*c);d=d(.5*e);b=f(.5*b);c=f(.5*c);e=f(.5*e);if("XYZ"===
a){var r=b*g*d+n*c*e;var u=n*c*d-b*g*e;var k=n*g*e+b*c*d;var l=n*g*d-b*c*e}else"YXZ"===a?(r=b*g*d+n*c*e,u=n*c*d-b*g*e,k=n*g*e-b*c*d,l=n*g*d+b*c*e):"ZXY"===a?(r=b*g*d-n*c*e,u=n*c*d+b*g*e,k=n*g*e+b*c*d,l=n*g*d-b*c*e):"ZYX"===a?(r=b*g*d-n*c*e,u=n*c*d+b*g*e,k=n*g*e-b*c*d,l=n*g*d+b*c*e):"YZX"===a?(r=b*g*d+n*c*e,u=n*c*d+b*g*e,k=n*g*e-b*c*d,l=n*g*d-b*c*e):"XZY"===a&&(r=b*g*d-n*c*e,u=n*c*d-b*g*e,k=n*g*e+b*c*d,l=n*g*d+b*c*e);this.setValue(r,u,k,l);return this},toMatrix3:function(){var a=[],b=this.x(),c=this.y(),
e=this.z(),d=this.w(),g=b*b,n=c*c,x=e*e,r=b*c,u=c*e,k=e*b;b*=d;c*=d;e*=d;a[0]=1-2*(n+x);a[1]=2*(r-e);a[2]=2*(k+c);a[3]=2*(r+e);a[4]=1-2*(x+g);a[5]=2*(u-b);a[6]=2*(k-c);a[7]=2*(u+b);a[8]=1-2*(g+n);return f.matrix3().fromArray(a)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z()+this.w()*this.w())},normalize:function(){var a=this.length();if(0===a)return this.set(0,0,0,1);a=1/a;return this.set(this.x()*a,this.y()*a,this.z()*a,this.w()*a)},multiply:function(a){return this.multiplyQuaternions(this,
a)},multiplyQuaternions:function(a,b){var c=a.x(),e=a.y(),d=a.z();a=a.w();var f=b.x(),g=b.y(),x=b.z();b=b.w();this.set(c*b+a*f+e*x-d*g,e*b+a*g+d*f-c*x,d*b+a*x+c*g-e*f,a*b-c*f-e*g-d*x);return this},clone:function(){return f.quaternion().set(this.x(),this.y(),this.z(),this.w())},free:function(){f.freeQuaternion(this)}})}function G(){this.elements=[1,0,0,0,1,0,0,0,1]}function W(){this.ID=0;this.solids=[];this.bodys=[];this.trans=new Ammo.btTransform;this.zero=new Ammo.btVector3;this.zero.set(0,0,0)}
function X(){this.ID=0;this.joints=[];this.t1=new Ammo.btTransform;this.t2=new Ammo.btTransform}function Y(){this.ID=0;this.softs=[]}function Z(){this.ID=0;this.terrains=[]}function H(a,b){var c=f.transform(),e=f.vector3();this.needsUpdate=!1;this.dataHeap=this.tmpData=this.data=null;this.type="terrain";1!==d.scale&&(b.pos=f.vectomult(b.pos,d.invScale),b.size=f.vectomult(b.size,d.invScale));var p=void 0===b.size?[1,1,1]:b.size,g=void 0===b.sample?[64,64]:b.sample,n=void 0===b.pos?[0,0,0]:b.pos,x=
void 0===b.quat?[0,0,0,1]:b.quat,r=void 0===b.mass?0:b.mass,u=void 0===b.margin?.02:b.margin,k=void 0===b.friction?.5:b.friction,l=void 0===b.restitution?0:b.restitution,m=void 0===b.flag?1:b.flag,h=void 0===b.heightScale?1:b.heightScale,t=void 0===b.upAxis?1:b.upAxis,D=b.hdt||"PHY_FLOAT",y=void 0!==b.flipEdge?b.flipEdge:!1;this.setData(b.heightData);this.update();b=new Ammo.btHeightfieldTerrainShape(g[0],g[1],this.data,h,-p[1],p[1],t,D,y);e.set(p[0]/g[0],1,p[2]/g[1]);b.setLocalScaling(e);b.setMargin(u);
c.identity().fromArray(n.concat(x));e.set(0,0,0);p=new Ammo.btDefaultMotionState(c);r=new Ammo.btRigidBodyConstructionInfo(r,p,b,e);r.set_m_friction(k);r.set_m_restitution(l);k=new Ammo.btRigidBody(r);k.setCollisionFlags(m);this.name=k.name=a;this.body=k;Ammo.destroy(r);c.free();e.free()}function aa(){this.ID=0;this.cars=[];this.trans=new Ammo.btTransform}function I(a,b,c){this.name=a;this.body=this.chassis=null;this.motor=this.breaking=this.steering=0;this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5];this.limitAngular=
[1,1,1];this.transforms=[];this.wheelBody=[];this.wheelJoint=[];this.wheelRadius=[];this.isRay=!0;this.data={mass:100,wMass:1,wWidth:.25,nWheel:b.nWheel||4,wPos:[1,0,1.6],engine:1E3,acceleration:10,maxSteering:24*f.torad,breaking:100,incSteering:.04,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6E3,s_length:.2,w_friction:10.5,w_roll:.001};
this.init(b,c)}function ba(){this.ID=0;this.heroes=[]}function ca(a,b){this.type="character";this.name=a;this.controller=this.body=null;this.speed=this.angle=0;this.wasJumping=!1;this.verticalVelocity=0;this.angleInc=.1;this.q=new Ammo.btQuaternion;this.position=new Ammo.btVector3;this.init(b)}function da(){this.ID=0;this.pairs=[]}function ea(a,b,c){this.name=c;this.result=0;this.type="collision";this.pa=[0,0,0];this.pb=[0,0,0];this.nb=[0,0,0];this.maxImpulse=this.impulse=this.distance=0;this.a=a;
this.b=b;this.f=new Ammo.ConcreteContactResultCallback;this.f.addSingleResult=function(){this.result=1}.bind(this)}function fa(){this.ID=0;this.rays=[];this.ray=null;this.results=[]}function ha(a,b){this.name=a;this.type="ray";this.precision=1;this.update(b);this.result={hit:!1,name:"",point:[0,0,0],normal:[0,0,0]}}var f={T:[],Q:[],V3:[],M3:[],torad:Math.PI/180,todeg:180/Math.PI,clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},eulerToQuadArray:function(a,b){b&&(a=f.vectomult(a,f.torad));a=
f.quaternion().setFromEuler(a);b=a.toArray();a.free();return b},getLength:function(){return"T:"+f.T.length+" Q:"+f.Q.length+" V:"+f.V3.length},destroy:function(){for(;0<f.T.length;)Ammo.destroy(f.T.pop());for(;0<f.Q.length;)Ammo.destroy(f.Q.pop());for(;0<f.V3.length;)Ammo.destroy(f.V3.pop());f.M3=[]},transform:function(){return 0<f.T.length?f.T.pop():new Ammo.btTransform},freeTransform:function(a){f.T.push(a)},quaternion:function(){return 0<f.Q.length?f.Q.pop():new Ammo.btQuaternion},freeQuaternion:function(a){f.Q.push(a)},
vector3:function(){return 0<f.V3.length?f.V3.pop():new Ammo.btVector3},freeVector3:function(a){f.V3.push(a)},matrix3:function(){return 0<f.M3.length?f.M3.pop():new G},freeMatrix3:function(a){f.M3.push(a)},vectomult:function(a,b){return a=a.map(function(a){return a*b})},distanceArray:function(a,b){var c=b[0]-a[0],e=b[1]-a[1];a=b[2]-a[2];return Math.sqrt(c*c+e*e+a*a)}};Object.assign(G.prototype,{set:function(a,b,c,e,d,f,g,x,r){var p=this.elements;p[0]=a;p[1]=e;p[2]=g;p[3]=b;p[4]=d;p[5]=x;p[6]=c;p[7]=
f;p[8]=r;return this},setV3:function(a,b,c){var e=this.elements;e[0]=a.x();e[3]=a.y();e[6]=a.z();e[1]=b.x();e[4]=b.y();e[7]=b.z();e[2]=c.x();e[5]=c.y();e[8]=c.z();return this},transpose:function(){var a=this.elements;var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this},fromArray:function(a,b){void 0===b&&(b=0);for(var c=0;9>c;c++)this.elements[c]=a[c+b];return this},multiply:function(a){var b=this.row(0),c=this.row(1),e=this.row(2),d=a.column(0),f=a.column(1);a=
a.column(2);var g=this.elements;g[0]=b.dot(d);g[1]=b.dot(f);g[2]=b.dot(a);g[3]=c.dot(d);g[4]=c.dot(f);g[5]=c.dot(a);g[6]=e.dot(d);g[7]=e.dot(f);g[8]=e.dot(a);b.free();c.free();e.free();d.free();f.free();a.free();return this},multiplyByVector3:function(a){var b=this.row(0),c=this.row(1),e=this.row(2);a=f.vector3().set(b.dot(a),c.dot(a),e.dot(a));b.free();c.free();e.free();return a},toQuaternion:function(){var a=this.elements,b=a[0]+a[4]+a[8];if(0<b){var c=2*Math.sqrt(b+1);var e=.25*c;b=(a[7]-a[5])/
c;var d=(a[2]-a[6])/c;a=(a[3]-a[1])/c}else a[0]>a[4]&&a[0]>a[8]?(c=2*Math.sqrt(1+a[0]-a[4]-a[8]),e=(a[7]-a[5])/c,b=.25*c,d=(a[1]+a[3])/c,a=(a[2]+a[6])/c):a[4]>a[8]?(c=2*Math.sqrt(1+a[4]-a[0]-a[8]),e=(a[2]-a[6])/c,b=(a[1]+a[3])/c,d=.25*c,a=(a[5]+a[7])/c):(c=2*Math.sqrt(1+a[8]-a[0]-a[4]),e=(a[3]-a[1])/c,b=(a[2]+a[6])/c,d=(a[5]+a[7])/c,a=.25*c);return f.quaternion().set(b,d,a,e)},row:function(a){var b=this.elements;a*=3;return f.vector3().set(b[a],b[a+1],b[a+2])},column:function(a){var b=this.elements;
return f.vector3().set(b[a],b[a+3],b[a+6])},free:function(){f.freeMatrix3(this)}});var d={Ar:null,ArPos:null,constraintDebug:!1,matrix:[],force:[],option:[],flow:{ray:[],terrain:[],vehicle:[]},world:null,gravity:null,scale:1,invscale:1,angle:0,key:[0,0,0,0,0,0,0,0],post:null,makeShape:null},g=new Map;Object.assign(W.prototype,{step:function(a,b){var c,e=this.trans,f=d.scale;this.bodys.forEach(function(d,g){c=b+8*g;a[c]=9.8*d.getLinearVelocity().length();d.getMotionState().getWorldTransform(e);e.toArray(a,
c+1,f)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){"solid"===a.type?d.world.removeCollisionObject(a):d.world.removeRigidBody(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b="solid"===a.type?!0:!1,c=b?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==c&&(b?this.solids.splice(c,1):this.bodys.splice(c,1),this.destroy(a))}},add:function(a,b){var c=
void 0!==a.name?a.name:"body"+this.ID++;this.remove(c);void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);var e=void 0===a.mass?0:a.mass,p=a.kinematic||!1,q=a.ghost||!1;q&&(e=0);var n=f.vector3(),x=f.vector3(),r=f.vector3(),u=f.vector3(),k=f.vector3(),l=f.transform(),m=void 0!==a.noMesh?a.noMesh:!1;p&&(a.flag=2,a.state=4,void 0===a.group&&(a.group=4));a.size=void 0===a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;1!==
d.scale&&(a.pos=f.vectomult(a.pos,d.invScale),a.size=f.vectomult(a.size,d.invScale),void 0!==a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,d.invScale)));var h=null;if("hardbox"===a.type||"hardbox"===a.type||"realhardbox"===a.type||"ChamferBox"===a.type)a.type="box";if("realcylinder"===a.type||"ChamferCyl"===a.type)a.type="cylinder";"realcone"===a.type&&(a.type="cone");"realsphere"===a.type&&(a.type="sphere");switch(a.type){case "plane":k.fromArray(a.dir||[0,1,0]);h=new Ammo.btStaticPlaneShape(k,
0);break;case "box":k.setValue(.5*a.size[0],.5*a.size[1],.5*a.size[2]);h=new Ammo.btBoxShape(k);break;case "sphere":h=new Ammo.btSphereShape(a.size[0]);break;case "cylinder":k.setValue(a.size[0],.5*a.size[1],.5*a.size[2]);h=new Ammo.btCylinderShape(k);break;case "cone":h=new Ammo.btConeShape(a.size[0],.5*a.size[1]);break;case "capsule":h=new Ammo.btCapsuleShape(a.size[0],a.size[1]);break;case "compound":h=new Ammo.btCompoundShape;for(var t,y,A=f.transform(),v=0;v<a.shapes.length;v++){t=a.shapes[v];
t.quat=void 0===t.quat?[0,0,0,1]:t.quat;1!==d.scale&&(t.pos=f.vectomult(t.pos,d.invScale),t.size=f.vectomult(t.size,d.invScale));A.identity().fromArray(t.pos.concat(t.quat));switch(t.type){case "box":k.setValue(.5*t.size[0],.5*t.size[1],.5*t.size[2]);y=new Ammo.btBoxShape(k);break;case "sphere":y=new Ammo.btSphereShape(t.size[0]);break;case "cylinder":k.setValue(t.size[0],.5*t.size[1],.5*t.size[2]);y=new Ammo.btCylinderShape(k);break;case "cone":y=new Ammo.btConeShape(t.size[0],.5*t.size[1]);break;
case "capsule":y=new Ammo.btCapsuleShape(t.size[0],t.size[1]);break;case "convex":y=new Ammo.btConvexHullShape;var w=t.v;v=0;for(var z=w.length;v<z;v+=3)w[v]*=t.size[0],w[v+1]*=t.size[1],w[v+2]*=t.size[2],k.fromArray(w,v),y.addPoint(k)}h.addChildShape(A,y)}A.free();break;case "mesh":h=new Ammo.btTriangleMesh;w=a.v;v=0;for(z=w.length;v<z;v+=9)x.set(w[v+0]*a.size[0],w[v+1]*a.size[1],w[v+2]*a.size[2]),r.set(w[v+3]*a.size[0],w[v+4]*a.size[1],w[v+5]*a.size[2]),u.set(w[v+6]*a.size[0],w[v+7]*a.size[1],w[v+
8]*a.size[2]),h.addTriangle(x,r,u,!0);h=0===e?new Ammo.btBvhTriangleMeshShape(h,!0,!0):new Ammo.btConvexTriangleMeshShape(h,!0);break;case "convex":h=new Ammo.btConvexHullShape;w=a.v;v=0;for(z=w.length;v<z;v+=3)w[v]*=a.size[0],w[v+1]*=a.size[1],w[v+2]*=a.size[2],k.fromArray(w,v),h.addPoint(k);a.optimized&&(h.recalcLocalAabb(),h.initializePolyhedralFeatures())}void 0!==h.setMargin&&"sphere"!==a.type&&"capsule"!==a.type&&"compound"!==a.type&&(void 0!==a.margin?h.setMargin(a.margin*d.invScale):void 0!==
h.getMargin&&1!==d.scale&&h.setMargin(h.getMargin()*d.invScale));if("isShape"==b)return h;l.identity().fromArray(a.pos.concat(a.quat));if("isGhost"==b)return c=new Ammo.btGhostObject,c.setCollisionShape(h),c.setCollisionFlags(a.flag||4),c.setWorldTransform(l),c;x.setValue(0,0,0);0!==e&&h.calculateLocalInertia(e,x);b=new Ammo.btDefaultMotionState(l);b=new Ammo.btRigidBodyConstructionInfo(e,b,h,x);void 0!==a.friction&&b.set_m_friction(a.friction);void 0!==a.restitution&&b.set_m_restitution(a.restitution);
void 0!==a.linear&&b.set_m_linearDamping(a.linear);void 0!==a.angular&&b.set_m_angularDamping(a.angular);void 0!==a.rolling&&b.set_m_rollingFriction(a.rolling);a.masscenter?(n.fromArray(a.masscenter).negate(),l.setIdentity(),l.setOrigin(n),q=new Ammo.btCompoundShape,q.addChildShape(l,h),l.identity().fromArray(a.pos.concat(a.quat)),n.setValue(0,0,0),q.calculateLocalInertia(e,n),b=new Ammo.btDefaultMotionState(l),b=new Ammo.btRigidBodyConstructionInfo(e,b,q,n)):q?(q=new Ammo.btGhostObject,q.setCollisionShape(h),
q.setWorldTransform(l),a.flag=a.flag||4,q.setCollisionFlags(a.flag),q.isGhost=!0):(q=new Ammo.btRigidBody(b),p&&(q.isKinematic=!0));q.name=c;0!==e||p?(q.setCollisionFlags(a.flag||0),q.setActivationState(a.state||1),a.neverSleep&&q.setSleepingThresholds(0,0),d.world.addRigidBody(q,a.group||1,a.mask||-1),m?(q.type="body",this.solids.push(q)):(q.type="body",this.bodys.push(q))):(q.setCollisionFlags(a.flag||1),d.world.addCollisionObject(q,a.group||2,a.mask||-1),q.type="solid",this.solids.push(q));q.breakable=
void 0!==a.breakable?a.breakable:!1;q.breakable&&(q.breakOption=void 0!==a.breakOption?a.breakOption:[250,1,2,1]);g.set(c,q);Ammo.destroy(b);this.applyOption(q,a);l.free();n.free();x.free();r.free();u.free();k.free()},applyOption:function(a,b){var c=f.vector3();void 0!==b.flag&&(a.setCollisionFlags(b.flag),a.isKinematic=2===b.flag?!0:!1);void 0!==b.state&&a.setActivationState(b.state);void 0!==b.activate&&a.activate();a.isGhost||(void 0!==b.group&&a.getBroadphaseProxy().set_m_collisionFilterGroup(b.group),
void 0!==b.mask&&a.getBroadphaseProxy().set_m_collisionFilterMask(b.mask),void 0!==b.damping&&a.setDamping(b.damping[0],b.damping[1]),void 0!==b.sleeping&&a.setSleepingThresholds(b.sleeping[0],b.sleeping[1]));void 0!==b.friction&&a.setFriction(b.friction);void 0!==b.restitution&&a.setRestitution(b.restitution);void 0!==b.rollingFriction&&a.setRollingFriction(b.rollingFriction);void 0!==b.linearVelocity&&a.setLinearVelocity(c.fromArray(b.linearVelocity,0,d.invScale));void 0!==b.angularVelocity&&a.setAngularVelocity(c.fromArray(b.angularVelocity));
void 0!==b.linearFactor&&a.setLinearFactor(c.fromArray(b.linearFactor));void 0!==b.angularFactor&&a.setAngularFactor(c.fromArray(b.angularFactor));void 0!==b.anisotropic&&a.setAnisotropicFriction(b.anisotropic[0],b.anisotropic[1]);void 0!==b.massProps&&a.setMassProps(b.massProps[0],b.massProps[1]);void 0!==b.gravity&&(b.gravity?a.setGravity(d.gravity):a.setGravity(this.zero));void 0!==b.ccdThreshold&&a.setCcdMotionThreshold(b.ccdThreshold);void 0!==b.ccdRadius&&a.setCcdSweptSphereRadius(b.ccdRadius);
c.free()}});Object.assign(X.prototype,{step:function(a,b){var c,e=this.t1,f=this.t2,q=d.scale;this.joints.forEach(function(d,p){c=b+14*p;e.copy(g.get(d.b1).getWorldTransform()).multiply(d.formA).toArray(a,c,q);f.copy(g.get(d.b2).getWorldTransform()).multiply(d.formB).toArray(a,c+7,q)})},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());this.ID=0},destroy:function(a){d.world.removeConstraint(a);a.formA.free();a.formB.free();Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=
g.get(a);var b=this.joints.indexOf(a);-1!==b&&(this.joints.splice(b,1),this.destroy(a))}},add:function(a){a.name=void 0!==a.name?a.name:"joint"+this.ID++;var b=a.name;this.remove(b);a.body1&&(a.b1=a.body1);a.body2&&(a.b2=a.body2);if(g.has(a.b1)&&g.has(a.b2)){var c=g.get(a.b1),e=g.get(a.b2);c.activate();e.activate();var p=f.vector3(),q=f.vector3().fromArray(a.pos1||[0,0,0]).multiplyScalar(d.invScale),n=f.vector3().fromArray(a.pos2||[0,0,0]).multiplyScalar(d.invScale),x=f.vector3().fromArray(a.axe1||
[1,0,0]),r=f.vector3().fromArray(a.axe2||[1,0,0]),u=f.transform().identity(),k=f.transform().identity();if(void 0!==a.local?a.local:1)u.setOrigin(q),void 0!==a.quatA?u.quaternionFromArray(a.quatA):a.axe1&&u.quartenionFromAxis(a.axe1),k.setOrigin(n),void 0!==a.quatB?k.quaternionFromArray(a.quatB):a.axe2&&k.quartenionFromAxis(a.axe2);else{var l=f.transform();l.identity();l.setOrigin(q);u.getInverse().multiply(l);l.identity();l.setOrigin(n);e.getMotionState().getWorldTransform(k);k.getInverse().multiply(l);
l.free()}l=void 0!==a.useA?a.useA:!0;switch(a.type){case "joint_p2p":var m=1;var h=new Ammo.btPoint2PointConstraint(c,e,q,n);a.strength&&h.get_m_setting().set_m_tau(a.strength);a.damping&&h.get_m_setting().set_m_damping(a.damping);a.impulse&&h.get_m_setting().set_m_impulseClamp(a.impulse);break;case "joint_hinge":case "joint":m=2;h=new Ammo.btHingeConstraint(c,e,q,n,x,r,l);break;case "joint_hinge_ref":m=2;h=new Ammo.btHingeConstraint(c,e,u,k,l);break;case "joint_slider":m=3;h=new Ammo.btSliderConstraint(c,
e,u,k,l);break;case "joint_conetwist":m=4;h=new Ammo.btConeTwistConstraint(c,e,u,k);break;case "joint_dof":m=5;h=new Ammo.btGeneric6DofConstraint(c,e,u,k,l);break;case "joint_spring_dof":m=6;h=new Ammo.btGeneric6DofSpringConstraint(c,e,u,k,l);break;case "joint_fixe":m=7,h=new Ammo.btFixedConstraint(c,e,u,k)}h.b1=a.b1;h.b2=a.b2;h.formA=u.clone();h.formB=k.clone();a.breaking&&h.setBreakingImpulseThreshold&&h.setBreakingImpulseThreshold(a.breaking);a.limit&&h.setLimit&&("joint_hinge"!==a.type&&"joint"!==
a.type&&"joint_hinge_ref"!==a.type||h.setLimit(a.limit[0]*f.torad,a.limit[1]*f.torad,void 0!==a.limit[2]?a.limit[2]:.9,void 0!==a.limit[3]?a.limit[3]:.3,void 0!==a.limit[4]?a.limit[4]:1),"joint_conetwist"===a.type&&(h.setLimit(3,a.limit[2]*f.torad),h.setLimit(4,a.limit[1]*f.torad),h.setLimit(5,a.limit[0]*f.torad)));a.limit&&"joint_slider"===a.type&&(a.limit[0]&&h.setLowerLinLimit(a.limit[0]*d.invScale),a.limit[1]&&h.setUpperLinLimit(a.limit[1]*d.invScale),a.limit[2]&&h.setLowerAngLimit(a.limit[2]*
f.torad),a.limit[3]&&h.setUpperAngLimit(a.limit[3]*f.torad));h.setLinearLowerLimit&&(a.linLower&&h.setLinearLowerLimit(p.fromArray(a.linLower).multiplyScalar(d.invScale)),a.linUpper&&h.setLinearUpperLimit(p.fromArray(a.linUpper).multiplyScalar(d.invScale)));h.setAngularLowerLimit&&(a.angLower&&h.setAngularLowerLimit(p.fromArray(a.angLower).multiplyScalar(f.torad)),a.angUpper&&h.setAngularUpperLimit(p.fromArray(a.angUpper).multiplyScalar(f.torad)));a.motor&&h.enableAngularMotor&&h.enableAngularMotor(a.motor[0],
a.motor[1],a.motor[2]);a.feedback&&h.enableFeedback(a.feedback);a.angularOnly&&h.setAngularOnly&&h.setAngularOnly(a.angularOnly?1:0);a.enableMotor&&h.enableMotor&&h.enableMotor(a.enableMotor);a.maxMotorImpulse&&h.setMaxMotorImpulse&&h.setMaxMotorImpulse(a.maxMotorImpulse);a.motorTarget&&h.setMotorTarget&&(c=f.quaternion().fromArray(a.motorTarget),h.setMotorTarget(c),c.free());if(a.damping&&h.setDamping)for(c=0;6>c;c++)h.setDamping(c,a.damping[c]);if(a.spring&&h.enableSpring&&h.setStiffness)for(c=
0;6>c;c++)h.enableSpring(c,0===a.spring[c]?!1:!0),h.setStiffness(c,a.spring[c]);if(a.param&&h.setParam)for(c=0,e=a.param.length;c<e;c++)h.setParam(a.param[c][0],a.param[c][1],c);a=void 0!==a.collision?a.collision:!1;h.isJoint=!0;h.name=b;h.nType=m;h.type="joint";d.world.addConstraint(h,a?!1:!0);this.joints.push(h);g.set(b,h);p.free();q.free();n.free();x.free();r.free();u.free();k.free()}else console.log("! not find body")},applyOption:function(a,b){}});Object.assign(function(a){this.type="constraint";
this.name=a.name}.prototype,{step:function(a,b){},init:function(a){},clear:function(){}});Object.assign(Y.prototype,{step:function(a,b){var c=b,e,f,g,n=d.scale;this.softs.forEach(function(b){f=b.get_m_nodes();for(g=f.size();g--;)e=c+3*g,f.at(g).get_m_x().toArray(a,e,n);c+=3*f.size()})},getNodes:function(a){var b=[];a=a.get_m_nodes();for(var c,e=a.size(),d=0;d<e;d++)c=a.at(d).get_m_x().toArray(),300<c[1]&&b.push(d);return b},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());
this.ID=0},destroy:function(a){d.world.removeSoftBody(a);Ammo.destroy(a);g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),this.destroy(a))}},addAreo:function(a){if(g.has(a.soft)){for(var b=g.get(a.soft),c=f.vector3().fromeArray(a.wind),d=a.nodes.length;d--;)b.addAeroForceToNode(c,a.nodes[d]);c.free()}},addAnchor:function(a){if(g.has(a.soft)&&g.has(a.body))for(var b=a.collision||!1,c=g.get(a.soft),d=g.get(a.body),f=a.nodes.length;f--;)c.appendAnchor(a.nodes[f],
d,b?!1:!0,a.influence||1)},add:function(a){var b=void 0!==a.name?a.name:"soft"+this.ID++;this.remove(b);var c=d.world.getWorldInfo(),e=a.gendiags||!0;a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.quat=void 0===a.quat?[0,0,0,1]:a.quat;a.div=void 0==a.div?[64,64]:a.div;1!==d.scale&&(a.pos=f.vectomult(a.pos,d.invScale),a.size=f.vectomult(a.size,d.invScale));var p=f.vector3(),q=f.vector3(),n=f.vector3(),x=f.vector3(),r=f.vector3(),u=f.transform(),k=new Ammo.btSoftBodyHelpers;
switch(a.type){case "softMesh":if(1!==d.scale)for(var l=a.v.length;l--;)a.v[l]*=d.invScale;var m=k.CreateFromTriMesh(c,a.v,a.i,a.ntri,a.randomize||!0);m.softType=5;break;case "softCloth":m=.5*a.size[0];l=.5*a.size[2];q.fromArray([-m,0,-l]);n.fromArray([m,0,-l]);x.fromArray([-m,0,l]);r.fromArray([m,0,l]);m=k.CreatePatch(c,q,n,x,r,a.div[0],a.div[1],a.fixed||0,e);m.softType=1;break;case "softRope":q.fromArray(a.start||[-10,0,0],0,d.invScale);n.fromArray(a.end||[10,0,0],0,d.invScale);m=k.CreateRope(c,
q,n,(a.numSegment||10)-2,a.fixed||0);m.softType=2;break;case "softEllips":q.fromArray(a.center||[0,0,0],0,d.invScale);n.fromArray(a.radius||[3,3,3],0,d.invScale);m=k.CreateEllipsoid(c,q,n,a.vertices||128);m.softType=3;c=[];k=m.get_m_nodes();l=k.size();for(var h;l--;)e=3*l,h=k.at(l),h=h.get_m_x(),c[e]=h.x(),c[e+1]=h.y(),c[e+2]=h.z();a.lng=k.size();a.a=c;self.postMessage({m:"ellipsoid",o:a});break;case "softConvex":m=a.v.length/3;for(l=0;l<m;l++);h=new Ammo.btConvexHullShape;for(l=0;l<m;l++)e=3*l,q.fromArray(a.v,
e,d.invScale),h.addPoint(q);h.initializePolyhedralFeatures();m=k.CreateFromConvexHull(c,h.getConvexPolyhedron(),h.getConvexPolyhedron().m_vertices.size(),a.randomize||!1);m.softType=4;console.log(m,m.get_m_nodes().size())}this.applyOption(m,a);u.identity().fromArray(a.pos.concat(a.quat));m.transform(u);d.world.addSoftBody(m,a.group||1,a.mask||-1);m.setActivationState(a.state||4);m.points=m.get_m_nodes().size();m.name=b;m.type="soft";this.softs.push(m);g.set(b,m);p.free();q.free();n.free();x.free();
r.free();u.free()},applyOption:function(a,b){var c=a.get_m_cfg();void 0!==b.viterations&&c.set_viterations(b.viterations);void 0!==b.piterations&&c.set_piterations(b.piterations);void 0!==b.diterations&&c.set_diterations(b.diterations);void 0!==b.citerations&&c.set_citerations(b.citerations);c.set_collisions(17);void 0!==b.friction&&c.set_kDF(b.friction);void 0!==b.damping&&c.set_kDP(b.damping);void 0!==b.pressure&&c.set_kPR(b.pressure);void 0!==b.drag&&c.set_kDG(b.drag);void 0!==b.lift&&c.set_kLF(b.lift);
void 0!==b.volume&&c.set_kVC(b.volume);void 0!==b.matching&&c.set_kMT(b.matching);void 0!==b.hardness&&(c.set_kCHR(b.hardness),c.set_kKHR(b.hardness),c.set_kSHR(b.hardness),c.set_kAHR(b.hardness));void 0!==b.timescale&&c.set_timescale(b.timescale);void 0!==b.maxvolume&&c.set_maxvolume(b.maxvolume);c=a.get_m_materials().at(0);void 0!==b.stiffness&&(c.set_m_kLST(b.stiffness),c.set_m_kAST(b.stiffness),c.set_m_kVST(b.stiffness));void 0!==b.bendingConstraint&&a.generateBendingConstraints(b.bendingConstraint,
c);a.setTotalMass(b.mass||0,b.fromfaces||!1);void 0!==b.cluster&&a.generateClusters(b.cluster,b.maxClusterIterations||8192);void 0!==b.restitution&&a.setRestitution(b.restitution);void 0!==b.rolling&&a.setRollingFriction(b.rolling);void 0!==b.flag&&a.setCollisionFlags(b.flag);void 0!==b.margin&&Ammo.castObject(a,Ammo.btCollisionObject).getCollisionShape().setMargin(b.margin*d.invScale)}});Object.assign(Z.prototype,{step:function(){for(var a=d.flow.terrain.length;a--;)this.setData(d.flow.terrain[a]);
d.flow.terrain=[];this.terrains.forEach(function(a){a.update()})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(a){d.world.removeCollisionObject(a.body);a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},setData:function(a){g.has(a.name)&&g.get(a.name).setData(a.heightData)},add:function(a){var b=void 0!==a.name?a.name:"terrain"+this.ID++;
this.remove(b);var c=void 0===a.group?2:a.group,e=void 0===a.mask?-1:a.mask;a=new H(b,a);d.world.addCollisionObject(a.body,c,e);this.terrains.push(a);g.set(b,a)}});Object.assign(H.prototype,{setData:function(a){this.tmpData=a;this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT;this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)},clear:function(){Ammo.destroy(this.body);Ammo._free(this.dataHeap.byteOffset);this.dataHeap=this.tmpData=
this.data=this.body=null},malloc:function(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,this.data,this.nDataBytes);this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}});Object.assign(aa.prototype,{step:function(a,b){for(var c=d.flow.vehicle.length;c--;)this.setData(d.flow.vehicle[c]);d.flow.vehicle=[];var e,f=this.trans;this.cars.forEach(function(c,d){e=b+64*d;c.step(a,e,f)})},control:function(a){g.has(a)&&g.get(a+"_constuctor").drive(d.key)},
clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){d.world.removeRigidBody(a.body);d.world.removeAction(a.chassis);Ammo.destroy(a.body);Ammo.destroy(a.chassis);g.delete(a.name+"_constuctor");g.delete(a.name);g.delete(a.name+"_chassis")},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},setData:function(a){g.has(a.name+"_constuctor")&&g.get(a.name+"_constuctor").setData(a)},add:function(a){var b=
void 0!==a.name?a.name:"car"+this.ID++;this.remove(b);a.size=void 0===a.size?[2,.5,4]:a.size;void 0!==a.pos&&(a.pos=f.vectomult(a.pos,d.invScale));void 0!==a.size&&(a.size=f.vectomult(a.size,d.invScale));void 0!==a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,d.invScale));var c=a.shapeType||"box";c=d.makeShape("mesh"==c?{type:"mesh",v:a.v,mass:1}:"convex"==c?{type:"convex",v:a.v}:{type:"box",size:a.size});void 0!==a.v&&delete a.v;a=new I(b,a,c);d.world.addAction(a.chassis);d.world.addRigidBody(a.body);
this.cars.push(a);g.set(b+"_constuctor",a);g.set(b,a.body);g.set(b+"_chassis",a.chassis)},applyOption:function(a,b){}});Object.assign(I.prototype,{step:function(a,b,c){var e=d.scale;a[b]=this.chassis.getCurrentSpeedKmHour();this.body.getMotionState().getWorldTransform(c);c.toArray(a,b+1,e);c=this.data.nWheel;for(var f,g;c--;)this.chassis.updateWheelTransform(c,!0),g=this.chassis.getWheelTransformWS(c),a[b+56+c]=this.chassis.getWheelInfo(c).get_m_raycastInfo().get_m_suspensionLength()*e,f=8*(c+1),
g.toArray(a,b+f+1,e),0===c&&(a[b+f]=this.chassis.getWheelInfo(0).get_m_steering()),1===c&&(a[b+f]=this.chassis.getWheelInfo(1).get_m_steering()),2===c&&(a[b+f]=this.steering);a[b+62]=this.chassis.getWheelInfo(0).m_rotation;a[b+63]=this.chassis.getWheelInfo(1).m_rotation},drive:function(a){var b=this.data;this.steering=0===a[0]?.9*this.steering:this.steering-b.incSteering*a[0];this.steering=f.clamp(this.steering,-b.maxSteering,b.maxSteering);0===a[1]?(this.motor=0,this.breaking=b.breaking):(this.motor-=
b.acceleration*a[1],this.breaking=0);this.motor=f.clamp(this.motor,-b.engine,b.engine);if(3<b.nWheel){var c=2*this.wpos[2],d=this.wpos[0];a=c/Math.tan(this.steering);var g=Math.atan2(c,d+a);c=Math.atan2(c,-d+a);0>a&&(g-=Math.PI,c-=Math.PI)}for(a=b.nWheel;a--;)4>b.nWheel?0===a&&this.chassis.setSteeringValue(this.steering,a):(0===a&&this.chassis.setSteeringValue(c,a),1===a&&this.chassis.setSteeringValue(g,a)),this.chassis.applyEngineForce(this.motor,a),this.chassis.setBrake(this.breaking,a);1>this.motor&&
(b=this.body.getAngularVelocity(),b.multiplyArray(this.limitAngular),this.body.setAngularVelocity(b))},clear:function(){this.chassis=this.body=null},init:function(a,b){var c=this.data,e=f.transform(),g=f.vector3(),q=f.vector3(),n=f.vector3(),x=f.vector3();this.isRay=void 0===a.isRay?!0:a.isRay;c.mass=void 0===a.mass?800:a.mass;a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;c.pos=void 0===a.pos?[0,0,0]:a.pos;c.quat=void 0===a.quat?[0,0,0,1]:a.quat;c.nWheel=a.nWheel||4;g.fromArray(a.masscenter).negate();
e.setIdentity();e.setOrigin(g);var r=new Ammo.btCompoundShape;r.addChildShape(e,b);e.identity().fromArray(c.pos.concat(c.quat));g.setValue(0,0,0);r.calculateLocalInertia(c.mass,g);b=new Ammo.btDefaultMotionState(e);r=new Ammo.btRigidBodyConstructionInfo(c.mass,b,r,g);this.body=new Ammo.btRigidBody(r);this.body.name=this.name;this.body.isRigidBody=!0;this.body.isBody=!0;this.body.setActivationState(4);Ammo.destroy(r);if(this.isRay){var u=new Ammo.btVehicleTuning;r=new Ammo.btDefaultVehicleRaycaster(d.world);
this.chassis=new Ammo.btRaycastVehicle(u,this.body,r);this.chassis.setCoordinateSystem(0,1,2)}r=a.radius||.4;b=a.radiusBack||r;var k=a.wPos||[1,0,1.6];k=f.vectomult(k,d.invScale);r*=d.invScale;b*=d.invScale;k[1]-=a.masscenter[1];c=c.nWheel;for(var l,m,h=a.decalYBack||0,t=0;t<c;t++)0===t&&(l=[k[0],k[1],k[2]],m=!0),1===t&&(l=[-k[0],k[1],k[2]],m=!0),2===t&&(l=[-k[0],k[1]+h,-k[2]],m=!1),3===t&&(l=[k[0],k[1]+h,-k[2]],m=!1),4===t&&(l=[-k[0],k[1]+h,-k[3]],m=!1),5===t&&(l=[k[0],k[1]+h,-k[3]],m=!1),2===c&&
(0===t&&(l=[0,k[1],k[2]],m=!0),1===t&&(l=[0,k[1]+h,-k[2]],m=!1)),3===c&&(0===t&&(l=[0,k[1],k[2]],m=!0),1===t&&(l=[k[0],k[1]+h,-k[2]],m=!1),2===t&&(l=[-k[0],k[1]+h,-k[2]],m=!1)),q.fromArray(l),n.setValue(0,-1,0),x.setValue(-1,0,0),this.chassis.addWheel(q,n,x,1,m?r:b,u,m),this.chassis.setBrake(a.breaking||100,t),this.wheelRadius.push(m?r:b),this.transforms.push(this.chassis.getWheelTransformWS(t));this.wpos=k;this.setData(a);e.free();g.free();q.free();n.free();x.free()},setMass:function(a){var b=f.vector3();
this.data.mass=a;b.setValue(0,0,0);this.body.getCollisionShape().calculateLocalInertia(this.data.mass,b);this.body.setMassProps(a,b);this.body.updateInertiaTensor();b.free()},setPosition:function(){this.motor=this.breaking=this.steering=0;var a=f.transform();a.identity().fromArray(this.data.pos.concat(this.data.quat));var b=f.vector3().set(0,0,0);this.body.setAngularVelocity(b);this.body.setLinearVelocity(b);this.body.setWorldTransform(a);this.chassis.resetSuspension();for(var c=this.data.nWheel;c--;)this.chassis.updateWheelTransform(c,
!0);a.free();b.free()},setData:function(a){var b=this.data;void 0!==a.mass&&a.mass!==b.mass&&this.setMass(a.mass);for(var c in a)void 0!==b[c]&&(b[c]=a[c]);this.body.setFriction(b.friction);this.body.setRestitution(b.restitution);this.body.setDamping(b.linear,b.angular);this.body.setRollingFriction(b.rolling);void 0!==a.limitAngular&&(this.limitAngular=a.limitAngular);c=f.vector3();void 0!==a.linearFactor&&this.body.setLinearFactor(c.fromArray(a.linearFactor));void 0!==a.angularFactor&&this.body.setAngularFactor(c.fromArray(a.angularFactor));
c.free();b.autoSuspension&&(c=Math.sqrt(b.s_stiffness),b.s_compression=2*b.compValue*c,b.s_damping=2*b.dampValue*c);c=b.nWheel;for(var e;c--;)e=this.chassis.getWheelInfo(c),e.set_m_suspensionStiffness(b.s_stiffness),e.set_m_wheelsDampingCompression(b.s_compression),e.set_m_wheelsDampingRelaxation(b.s_damping),e.set_m_maxSuspensionTravelCm(100*b.s_travel*d.invScale),e.set_m_suspensionRestLength1(b.s_length*d.invScale),e.set_m_maxSuspensionForce(b.s_force),e.set_m_rollInfluence(b.w_roll),e.set_m_frictionSlip(b.w_friction),
e.set_m_wheelsRadius(this.wheelRadius[c]);a.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",o:this.data})}});Object.assign(ba.prototype,{step:function(a,b){var c;this.heroes.forEach(function(d,f){c=b+8*f;d.step(a,c)})},control:function(a){g.has(a)&&(a=g.get(a),a.move(d.key),a.setAngle(d.angle))},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){d.world.removeCollisionObject(a.body);d.world.removeAction(a.controller);
a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"hero"+this.ID++;this.remove(b);var c=new ca(b,a);d.world.addCollisionObject(c.body,a.group||1,a.mask||-1);d.world.addAction(c.controller);this.heroes.push(c);g.set(b,c)}});Object.assign(ca.prototype,{isCharacter:!0,step:function(a,b){a[b]=this.speed;this.body.getWorldTransform().toArray(a,b+1,d.scale)},
move:function(a){1==a[4]&&this.controller.canJump();var b=.3*-a[1];var c=.3*-a[0];this.speed=b+c;this.angle-=.1*a[2];this.setAngle(this.angle);this.position.setValue(c,0+this.verticalVelocity,b);this.position.direction(this.q);this.controller.setWalkDirection(this.position)},clear:function(){Ammo.destroy(this.body);Ammo.destroy(this.controller);this.controller=this.body=null},init:function(a){var b=f.vector3(),c=f.transform();a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;
a.quat=void 0==a.quat?[0,0,0,1]:a.quat;1!==d.scale&&(a.pos=f.vectomult(a.pos,d.invScale),void 0!==a.masscenter&&(a.masscenter=f.vectomult(a.masscenter,d.invScale)));var e=d.makeShape(a.shapeInfo||{type:"capsule",size:a.size}),g=new Ammo.btPairCachingGhostObject;c.identity().fromArray(a.pos.concat(a.quat));g.setWorldTransform(c);g.setCollisionShape(e);g.setCollisionFlags(16);g.setFriction(a.friction||.1);g.setRestitution(a.restitution||0);g.setActivationState(4);g.activate();this.body=g;c=new Ammo.btKinematicCharacterController(g,
e,a.stepH||.35,a.upAxis||1);c.setUseGhostSweepTest(e);b.setValue(0,0,0);c.setVelocityForTimeInterval(b,1);this.controller=c;this.applyOption(a);this.setAngle(0);console.log(c,g)},applyOption:function(a){var b=this.controller;void 0!==a.gravity&&b.setGravity(a.gravity);void 0!==a.upAxis&&b.setUpAxis(a.upAxis);void 0!==a.canJump&&b.canJump(a.canJump);void 0!==a.maxJumpHeight&&b.setMaxJumpHeight(a.maxJumpHeight);void 0!==a.jumpSpeed&&b.setJumpSpeed(a.jumpSpeed);void 0!==a.fallSpeed&&b.setFallSpeed(a.fallSpeed);
void 0!==a.slopeRadians&&b.setMaxSlope(a.slopeRadians);void 0!==a.angle&&this.setAngle(a.angle);void 0!==a.position&&(this.position.fromArray(a.position,0,d.invScale),this.position.direction(this.q),b.setWalkDirection(this.position))},setMatrix:function(a){var b=f.vector3();a.pos=f.vectomult(a.pos,d.invScale);b.fromArray(a.pos);this.controller.warp(b);b.free()},setAngle:function(a){var b=this.body.getWorldTransform();this.q.setFromAxisAngle([0,1,0],a);b.setRotation(this.q);this.angle=a}});Object.assign(da.prototype,
{step:function(a,b){var c;this.pairs.forEach(function(e,f){c=b+f;e.result=0;void 0!==e.b?d.world.contactPairTest(e.a,e.b,e.f):d.world.contactTest(e.a,e.f);a[c]=e.result})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(a){a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"pair"+this.ID++;if(g.has(a.b1)){var c=
g.get(a.b1);a=void 0!==a.b2?g.has(a.b2)?g.get(a.b2):void 0:void 0;c=new ea(c,a,b);this.pairs.push(c);g.set(b,c)}}});Object.assign(ea.prototype,{clear:function(){this.b=this.a=null;Ammo.destroy(this.f)}});Object.assign(fa.prototype,{step:function(){if(null!==this.ray){var a=this.rays.length,b=d.flow.ray.length;if(a){if(a===b)for(;b--;)this.rays[b].update(d.flow.ray[b]);d.flow.ray=[];var c=this.ray;this.rays.forEach(function(a,b){c.set_m_closestHitFraction(a.precision);c.set_m_collisionObject(null);
c.get_m_rayFromWorld().fromArray(a.origin,0,d.invScale);c.get_m_rayToWorld().fromArray(a.dest,0,d.invScale);c.set_m_collisionFilterGroup(a.group);c.set_m_collisionFilterMask(a.mask);d.world.rayTest(c.get_m_rayFromWorld(),c.get_m_rayToWorld(),c);if(c.hasHit()){b=Ammo.castObject(c.get_m_collisionObject(),Ammo.btRigidBody).name;void 0===b&&(b=Ammo.castObject(c.get_m_collisionObject(),Ammo.btSoftBody).name);var e=c.get_m_hitNormalWorld();e.normalize();a.result.hit=!0;a.result.name=b;a.result.point=c.get_m_hitPointWorld().toArray(void 0,
0,d.scale);a.result.normal=e.toArray()}else a.result.hit=!1,a.result.name="";d.flow.ray.push(a.result)})}}},update:function(a){var b=this.rays.length;if(b&&b===a.length)for(;b--;)this.rays[b].update(a[b])},clear:function(){for(;0<this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(a){a.clear();g.delete(a.name)},remove:function(a){if(g.has(a)){a=g.get(a);var b=this.rays.indexOf(a);-1!==b&&(this.rays.splice(b,1),this.destroy(a))}},add:function(a){null===this.ray&&(this.ray=new Ammo.ClosestRayResultCallback);
var b=void 0!==a.name?a.name:"ray"+this.ID++;this.remove(a.name);a=new ha(b,a);this.rays.push(a);g.set(b,a)}});Object.assign(ha.prototype,{update:function(a){this.precision=a.precision||1;this.origin=a.origin||[0,0,0];this.dest=a.dest||[0,1,0];this.group=void 0!==a.group?a.group:1;this.mask=void 0!==a.mask?a.mask:-1},clear:function(){}});self.onmessage=function(a){a=a.data;a.Ar&&y.engine.setAr(a.Ar);a.flow&&(d.flow=a.flow);y.engine[a.m](a.o)};y.engine=function(){var a=null,b=!1,c="undefined"===typeof performance?
Date:performance,e,p,q,n=1/60,x=3*n,r=!1,u=2,k=0,l=!1,m=!1,h=!1,t,D,A,v,w,z=[],Q="",R="",J=null,S=0,G,H,K=0,I=0,T=0,U=0,V,B,C,L,M,E,N,O,P;y.engine={test:function(){},setAr:function(a){e=a},getAr:function(){return e},setDrive:function(a){Q=a},setMove:function(a){R=a},setAngle:function(a){d.angle=a.angle},internStep:function(b){d.key=b.key;U=c.now();a&&clearInterval(a);a=setInterval(function(){K=c.now();y.engine.step({delta:.001*(K-U)});U=K},1E3*n);console.log("is interne update")},step:function(a){b?
(K-1E3>I&&(I=K,V=T,T=0),T++):d.key=a.key;k=a.delta;this.stepRemove();E.control(Q);N.control(R);this.stepMatrix();this.stepOptions();this.stepForces();M.step();0!==S&&this.stepBreak();r?d.world.stepSimulation(n,0):d.world.stepSimulation(k,u,n);B.step(e,p[0]);O.step(e,p[1]);N.step(e,p[2]);E.step(e,p[3]);C.step(e,p[4]);h&&L.step(e,p[5]);P.step();l?self.postMessage({m:"step",fps:V,delta:0,flow:d.flow,Ar:e},[e.buffer]):self.postMessage({m:"step",fps:V,delta:k,flow:d.flow,Ar:e})},clearFlow:function(){d.flow=
{ray:[],terrain:[],vehicle:[]}},reset:function(a){S=0;R=Q="";this.clearFlow();z=[];d.matrix=[];d.option=[];d.force=[];B.clear();L.clear();C.clear();M.clear();E.clear();N.clear();O.clear();P.clear();g.clear();f.destroy();a.full&&(this.clearWorld(),this.createWorld());this.setGravity();l||(e=new Float32Array(q));self.postMessage({m:"start"})},addMulty:function(a){for(var b=0,c=a.length;b<c;b++)this.add(a[b])},post:function(a,b){self.postMessage({m:a,o:b})},init:function(a){l=a.isBuffer||!1;p=a.ArPos;
q=a.ArMax;l||(e=new Float32Array(q));importScripts(a.blob);Ammo().then(function(b){F();y.engine.createWorld(a.option);y.engine.set(a.option);B=new W;L=new X;C=new Y;M=new Z;E=new aa;N=new ba;O=new da;P=new fa;new b.ClosestRayResultCallback;G=f.transform();H=f.vector3();d.makeShape=function(a){return B.add(a,"isShape")};self.postMessage({m:"initEngine"})})},remove:function(a){if(g.has(a))switch(g.get(a).type){case "solid":case "body":B.remove(a);break;case "soft":C.remove(a);break;case "terrain":M.remove(a);
break;case "joint":case "constraint":L.remove(a);break;case "collision":O.remove(a);break;case "ray":P.remove(a)}},setRemove:function(a){z=z.concat(a)},stepRemove:function(){for(;0<z.length;)this.remove(z.pop())},directRemoves:function(a){this.setRemove(a);this.stepRemove()},add:function(a){a.type=void 0===a.type?"box":a.type;void 0!==a.breakable&&a.breakable&&S++;var b=a.type,c=a.type.substring(0,4);"join"===c?L.add(a):"soft"===c||"ellipsoid"===b?C.add(a):"terrain"===b?M.add(a):"character"===b?N.add(a):
"collision"===b?O.add(a):"ray"===b?P.add(a):"car"===b?E.add(a):B.add(a)},addAnchor:function(a){C.addAnchor(a)},setVehicle:function(a){E.setData(a)},createWorld:function(a){if(null!==d.world)console.error("World already existe !!");else{a=a||{};J=new Ammo.btVector3;J.set(0,0,0);m=void 0===a.soft?!0:a.soft;t=new Ammo.btSequentialImpulseConstraintSolver;D=m?new Ammo.btDefaultSoftBodySolver:null;A=m?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration;v=new Ammo.btCollisionDispatcher(A);
switch(void 0===a.broadphase?2:a.broadphase){case 1:w=new Ammo.btAxisSweep3(new Ammo.btVector3(-1E3,-1E3,-1E3),new Ammo.btVector3(1E3,1E3,1E3),4096);break;case 2:w=new Ammo.btDbvtBroadphase}d.world=m?new Ammo.btSoftRigidDynamicsWorld(v,w,t,A,D):new Ammo.btDiscreteDynamicsWorld(v,w,t,A);d.post=this.post}},clearWorld:function(){Ammo.destroy(d.world);Ammo.destroy(t);null!==D&&Ammo.destroy(D);Ammo.destroy(A);Ammo.destroy(v);Ammo.destroy(w);d.world=null},setWorldscale:function(a){d.scale=a;d.invScale=
1/a},setGravity:function(a){a=a||{};d.gravity=new Ammo.btVector3;d.gravity.fromArray(void 0!==a.gravity?a.gravity:[0,-9.81,0]);d.world.setGravity(d.gravity);m&&d.world.getWorldInfo().set_m_gravity(d.gravity)},set:function(a){a=a||{};this.setWorldscale(void 0!==a.worldscale?a.worldscale:1);n=void 0!==a.fps?1/a.fps:1/60;u=void 0!==a.substep?a.substep:2;r=void 0!==a.fixed?a.fixed:!1;b=a.isInternUpdate||!1;h=void 0!==a.jointDebug?a.jointDebug:!1;d.constraintDebug=h;x=3*n;void 0!==a.penetration&&d.world.getDispatchInfo().set_m_allowedCcdPenetration(a.penetration);
this.setGravity(a)},setForces:function(a){d.force=d.force.concat(a)},directForces:function(a){this.setForces(a);this.stepForces()},stepForces:function(){for(var a=d.force.length;a--;)this.applyForces(d.force[a]);d.force=[]},applyForces:function(a){var b=a.name;if(g.has(b)){b=g.get(b);var c=f.vector3(),e=f.vector3(),h=f.quaternion();void 0!==a.direction&&c.fromArray(f.vectomult(a.direction,d.invScale));void 0!==a.distance?e.fromArray(f.vectomult(a.distance,d.invScale)):e.zero();switch(a.type){case "force":case 0:b.applyForce(c,
e);break;case "torque":case 1:b.applyTorque(c);break;case "localTorque":case 2:b.applyLocalTorque(c);break;case "forceCentral":case 3:b.applyCentralForce(c);break;case "forceLocal":case 4:b.applyCentralLocalForce(c);break;case "impulse":case 5:b.applyImpulse(c,e);break;case "impulseCentral":case 6:b.applyCentralImpulse(c);break;case "motor":case 7:b.enableAngularMotor(a.enable||!0,a.targetVelocity,a.maxMotor);break;case "motorTarget":case 8:b.setMotorTarget(a.target,a.axis||-1);case "setLimit":case 9:b.setLimit(a.limit[0]*
f.torad,a.limit[1]*f.torad,a.limit[2]||.9,a.limit[3]||.3,a.limit[4]||1)}c.free();e.free();h.free()}},setMatrix:function(a){d.matrix=d.matrix.concat(a)},directMatrix:function(a){this.setMatrix(a);this.stepMatrix()},stepMatrix:function(){for(var a=d.matrix.length;a--;)this.applyMatrix(d.matrix[a]);d.matrix=[]},applyMatrix:function(a){var b=a.name;if(g.has(b)){var c=g.get(b);if(c.isCharacter)c.setMatrix(a);else{var e=G.identity(),h=H;void 0===a.rot&&void 0===a.quat&&(a.quat=[0,0,0,1]);if(a.keepX||a.keepY||
a.keepZ||a.keepRot){c.getMotionState().getWorldTransform(e);var l=[];e.toArray(l);void 0!==a.keepX&&(a.pos[0]=l[0]-a.pos[0]);void 0!==a.keepY&&(a.pos[1]=l[1]-a.pos[1]);void 0!==a.keepZ&&(a.pos[2]=l[2]-a.pos[2]);void 0!==a.keepRot&&(a.quat=[l[3],l[4],l[5],l[6]])}void 0!==a.pos&&(void 0!==a.rot&&(a.quat=f.eulerToQuadArray(a.rot,!0)),a.pos=a.pos.concat(a.quat),e.fromArray(a.pos,0,d.invScale),c.isKinematic?c.getMotionState().setWorldTransform(e):c.setWorldTransform(e));void 0!==a.clamped&&(e=k>x?1:k/
x,h.fromArray(a.pos,0,d.invScale).sub(c.getWorldTransform().getOrigin()).multiplyScalar(e),c.setLinearVelocity(h));a.velocity&&!c.isGhost&&(a.velocity[0]&&c.setLinearVelocity(h.fromArray(a.velocity[0],0,d.invScale)),a.velocity[1]&&c.setAngularVelocity(h.fromArray(a.velocity[1])));a.noVelocity&&!c.isGhost&&(c.setLinearVelocity(J),c.setAngularVelocity(J));a.noGravity&&c.setGravity(J);a.activate&&c.activate();"body"!==c.type||c.isKinematic||c.activate();"solid"===c.type&&self.postMessage({m:"moveSolid",
o:{name:b,pos:a.pos,quat:a.quat}})}}},setOptions:function(a){d.option=d.option.concat(a)},directOptions:function(a){this.setOptions(a);this.stepOptions()},stepOptions:function(){for(var a=d.option.length;a--;)this.applyOption(d.option[a]);d.option=[]},applyOption:function(a){var b=a.name;if(g.has(b))switch(b=g.get(b),b.type){case "solid":case "body":B.applyOption(b,a);break;case "soft":C.applyOption(b,a);break;case "character":b.applyOption(a)}},stepBreak:function(){for(var a,b,c,e,g,h,k,l,m,n,p=
0,q=v.getNumManifolds();p<q;p++)if(a=v.getManifoldByIndexInternal(p),m=Ammo.castObject(a.getBody0(),Ammo.btRigidBody),n=Ammo.castObject(a.getBody1(),Ammo.btRigidBody),k=m.name,l=n.name,m.breakable||n.breakable){c=!1;for(var r=e=0,t=a.getNumContacts();r<t;r++)if(b=a.getContactPoint(r),0>b.getDistance()){c=!0;a=b.getAppliedImpulse();a>e&&(e=a,g=b.get_m_positionWorldOnB().toArray(),h=b.get_m_normalWorldOnB().toArray());break}c&&(m.breakable&&e>m.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:k,
pos:f.vectomult(g,d.scale),normal:h,breakOption:m.breakOption}}),n.breakable&&e>n.breakOption[0]&&self.postMessage({m:"makeBreak",o:{name:l,pos:f.vectomult(g,d.scale),normal:h,breakOption:n.breakOption}}))}}};return y.engine}();Object.defineProperty(y,"__esModule",{value:!0})});
