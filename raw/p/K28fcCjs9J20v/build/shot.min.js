(function(g,I){"object"===typeof exports&&"undefined"!==typeof module?I(exports):"function"===typeof define&&define.amd?define(["exports"],I):(g=g||self,I(g.SHOT={}))})(this,function(g){function I(){this.tolerance=-1;this.faces=[];this.newFaces=[];this.assigned=new V;this.unassigned=new V;this.vertices=[]}function A(){this.normal=new THREE.Vector3;this.midpoint=new THREE.Vector3;this.constant=this.area=0;this.outside=null;this.mark=0;this.edge=null}function J(a,b){this.vertex=a;this.twin=this.next=
this.prev=null;this.face=b}function ja(a){this.point=a;this.face=this.next=this.prev=null}function V(){this.tail=this.head=null}function K(a,b){var c=!1;if("mesh"==b||"convex"==b)c=!0;var f=a.isBufferGeometry?(new THREE.Geometry).fromBufferGeometry(a):a;f.mergeVertices();var d=a.attributes.position.array.length/3,v=f.vertices.length,h=f.faces.length;a.realVertices=new Float32Array(3*v);a.realIndices=new (65535<3*h?Uint32Array:Uint16Array)(3*h);a.setAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
d),3));var e=a.attributes.color.array;for(b=d;b--;){var m=3*b;e[m]=1;e[m+1]=1;e[m+2]=1}for(b=v;b--;)e=f.vertices[b],m=3*b,a.realVertices[m]=e.x,a.realVertices[m+1]=e.y,a.realVertices[m+2]=e.z;for(b=h;b--;)e=f.faces[b],m=3*b,a.realIndices[m]=e.a,a.realIndices[m+1]=e.b,a.realIndices[m+2]=e.c;f.dispose();if(c){d=[];for(b=a.realIndices.length;b--;)m=3*b,e=3*a.realIndices[b],d[m]=a.realVertices[e],d[m+1]=a.realVertices[e+1],d[m+2]=a.realVertices[e+2];return d}f=[];var g=a.attributes.position.array;for(b=
v;b--;)for(m=3*b,f[b]=[],c=d;c--;)e=3*c,g[e]==a.realVertices[m]&&g[e+1]==a.realVertices[m+1]&&g[e+2]==a.realVertices[m+2]&&f[b].push(c);g=new (65535<v?Uint32Array:Uint16Array)(v);var n=new (65535<d?Uint32Array:Uint16Array)(d);for(b=e=0;b<v;b++){m=f[b].length;g[b]=e;for(c=m;c--;)n[e+c]=f[b][c];e+=m}a.numFaces=h;a.numVertices=v;a.maxi=d;a.pPoint=g;a.lPoint=n}function L(a,b,c,f){THREE.BufferGeometry.call(this);this.type="Capsule";a=a||1;b=b||1;var d=Math.PI;c=Math.floor(c)||12;var v=Math.floor(.5*c);
f=Math.floor(f)||1;var e=2*Math.PI,k=.5*Math.PI,m=new THREE.Geometry;f=new THREE.CylinderGeometry(a,a,b,c,f,!0);var g=new THREE.Matrix4,n=new THREE.SphereGeometry(a,c,v,0,e,0,k);a=new THREE.SphereGeometry(a,c,v,0,e,k,k);c=(new THREE.Matrix4).makeTranslation(0,0,0);v=(new THREE.Matrix4).makeTranslation(0,.5*b,0);b=(new THREE.Matrix4).makeTranslation(0,.5*-b,0);g.makeRotationZ(d);m.merge(f,c.multiply(g));m.merge(n,v);m.merge(a,b);m.mergeVertices();m.computeVertexNormals();f.dispose();n.dispose();a.dispose();
this.fromGeometry(m);m.dispose()}function O(a){THREE.Geometry.call(this);this.fromBufferGeometry(new B(a));this.mergeVertices()}function B(a){THREE.BufferGeometry.call(this);var b=[],c=[];a=(new I).setFromPoints(a).faces;for(var f=0;f<a.length;f++){var d=a[f],v=d.edge;do{var e=v.head().point;b.push(e.x,e.y,e.z);c.push(d.normal.x,d.normal.y,d.normal.z);v=v.next}while(v!==d.edge)}this.setAttribute("position",new THREE.Float32BufferAttribute(b,3));this.setAttribute("normal",new THREE.Float32BufferAttribute(c,
3))}function W(){this.ID=0;this.solids=[];this.bodys=[]}function X(){this.ID=0;this.joints=[]}function Y(a){this.type="constraint";this.name=a.name;this.isMesh=!1;e.constraintDebug&&this.init(a)}function Z(){this.ID=0;this.softs=[];this.tmpMat=null}function aa(a,b){var c=a.shape.clone();c.scale(a.size[0],a.size[1],a.size[2]);K(c);e.extraGeo.push(c);a.v=c.realVertices;a.i=c.realIndices;a.ntri=c.numFaces;c.translate(a.pos[0],a.pos[1],a.pos[2]);c.applyMatrix(e.tmpM.makeRotationFromQuaternion(e.tmpQ.fromArray(a.quat)));
b=new THREE.Mesh(c,b);b.castShadow=!0;b.receiveShadow=!0;b.softType=5;b.points=a.v.length/3;a.shape&&delete a.shape;a.material&&delete a.material;return{mesh:b,o:a}}function ba(){this.ID=0;this.terrains=[]}function ca(){this.ID=0;this.cars=[]}function da(){this.ID=0;this.heroes=[]}function ea(){this.ID=0;this.pairs=[]}function fa(a,b){this.name=a;this.callback=b||function(){};this.type="collision";this.hit=0}function ha(){this.ID=0;this.rays=[]}function ia(a){THREE.Line.call(this);this.type="ray";
this.name=a.name;this.enabled=void 0!==a.enabled?a.enabled:!0;this.precision=void 0!==a.precision?a.precision:1;this.callback=a.callback||function(){};this.position.fromArray(a.pos||[0,0,0]);this.group=void 0!==a.group?a.group:1;this.mask=void 0!==a.mask?a.mask:-1;this.origin=[0,0,0];this.dest=[0,0,0];this.start=(new THREE.Vector3).fromArray(a.start||[0,0,0]);this.end=(new THREE.Vector3).fromArray(a.end||[0,10,0]);this.maxDistance=this.start.distanceTo(this.end);this.tmp=new THREE.Vector3;this.normal=
new THREE.Vector3;this.inv=new THREE.Matrix4;this.c1=[.1,.1,.1];this.c2=[1,.1,.1];this.vertices=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.local=[0,0,0,0,0,0];this.geometry.setAttribute("position",new THREE.Float32BufferAttribute(this.vertices,3));this.geometry.setAttribute("color",new THREE.Float32BufferAttribute(this.colors,3));this.vertices=this.geometry.attributes.position.array;this.colors=this.geometry.attributes.color.array;this.material.color.setHex(16777215);
this.material.vertexColors=THREE.VertexColors;this.base=!1;this.info={hit:!1,name:"",distance:0};this.upGeo()}function D(a,b){this.minSizeForBreak=a||1.4;this.smallDelta=b||1E-4;this.tempLine1=new THREE.Line3;this.tempPlane1=new THREE.Plane;this.tempPlane2=new THREE.Plane;this.tempPlane_Cut=new THREE.Plane;this.tempCM1=new THREE.Vector3;this.tempCM2=new THREE.Vector3;this.tempVector3=new THREE.Vector3;this.tempVector3_2=new THREE.Vector3;this.tempVector3_3=new THREE.Vector3;this.tempVector3_P0=new THREE.Vector3;
this.tempVector3_P1=new THREE.Vector3;this.tempVector3_P2=new THREE.Vector3;this.tempVector3_N0=new THREE.Vector3;this.tempVector3_N1=new THREE.Vector3;this.tempVector3_AB=new THREE.Vector3;this.tempVector3_CB=new THREE.Vector3;this.tempResultObjects={object1:null,object2:null};this.segments=[];for(a=0;900>a;a++)this.segments[a]=!1}function ka(a){a=new Uint8Array(a);var b={data:[],position:0,writeByte:function(a){this.data[this.position++]=a}};la.decompressFile({data:a,position:0,readByte:function(){return this.data[this.position++]}},
b);return(new Uint8Array(b.data)).buffer}var ma=new THREE.Vector3;Object.assign(I.prototype,{setFromPoints:function(a){!0!==Array.isArray(a)&&console.error("THREE.ConvexHull: Points parameter is not an array.");4>a.length&&console.error("THREE.ConvexHull: The algorithm needs at least four points.");this.makeEmpty();for(var b=0,c=a.length;b<c;b++)this.vertices.push(new ja(a[b]));this.compute();return this},setFromObject:function(a){var b=[];a.updateMatrixWorld(!0);a.traverse(function(a){var c;var d=
a.geometry;if(void 0!==d)if(d.isGeometry){var e=d.vertices;d=0;for(c=e.length;d<c;d++){var h=e[d].clone();h.applyMatrix4(a.matrixWorld);b.push(h)}}else if(d.isBufferGeometry&&(e=d.attributes.position,void 0!==e))for(d=0,c=e.count;d<c;d++)h=new THREE.Vector3,h.fromBufferAttribute(e,d).applyMatrix4(a.matrixWorld),b.push(h)});return this.setFromPoints(b)},containsPoint:function(a){for(var b=this.faces,c=0,f=b.length;c<f;c++)if(b[c].distanceToPoint(a)>this.tolerance)return!1;return!0},intersectRay:function(a,
b){for(var c=this.faces,f=-Infinity,d=Infinity,e=0,h=c.length;e<h;e++){var k=c[e],m=k.distanceToPoint(a.origin);k=k.normal.dot(a.direction);if(0<m&&0<=k)return null;m=0!==k?-m/k:0;if(!(0>=m)&&(0<k?d=Math.min(m,d):f=Math.max(m,f),f>d))return null}-Infinity!==f?a.at(f,b):a.at(d,b);return b},intersectsRay:function(a){return null!==this.intersectRay(a,ma)},makeEmpty:function(){this.faces=[];this.vertices=[];return this},addVertexToFace:function(a,b){a.face=b;null===b.outside?this.assigned.append(a):this.assigned.insertBefore(b.outside,
a);b.outside=a;return this},removeVertexFromFace:function(a,b){a===b.outside&&(b.outside=null!==a.next&&a.next.face===b?a.next:null);this.assigned.remove(a);return this},removeAllVerticesFromFace:function(a){if(null!==a.outside){for(var b=a.outside,c=a.outside;null!==c.next&&c.next.face===a;)c=c.next;this.assigned.removeSubList(b,c);b.prev=c.next=null;a.outside=null;return b}},deleteFaceVertices:function(a,b){a=this.removeAllVerticesFromFace(a);if(void 0!==a)if(void 0===b)this.unassigned.appendChain(a);
else{do{var c=a.next;b.distanceToPoint(a.point)>this.tolerance?this.addVertexToFace(a,b):this.unassigned.append(a);a=c}while(null!==a)}return this},resolveUnassignedPoints:function(a){if(!1===this.unassigned.isEmpty()){var b=this.unassigned.first();do{for(var c=b.next,f=this.tolerance,d=null,e=0;e<a.length;e++){var h=a[e];if(0===h.mark){var k=h.distanceToPoint(b.point);k>f&&(f=k,d=h);if(f>1E3*this.tolerance)break}}null!==d&&this.addVertexToFace(b,d);b=c}while(null!==b)}return this},computeExtremes:function(){var a=
new THREE.Vector3,b=new THREE.Vector3,c=[],f=[],d,e,h;for(d=0;3>d;d++)c[d]=f[d]=this.vertices[0];a.copy(this.vertices[0].point);b.copy(this.vertices[0].point);d=0;for(e=this.vertices.length;d<e;d++){var k=this.vertices[d],m=k.point;for(h=0;3>h;h++)m.getComponent(h)<a.getComponent(h)&&(a.setComponent(h,m.getComponent(h)),c[h]=k);for(h=0;3>h;h++)m.getComponent(h)>b.getComponent(h)&&(b.setComponent(h,m.getComponent(h)),f[h]=k)}this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(a.x),Math.abs(b.x))+Math.max(Math.abs(a.y),
Math.abs(b.y))+Math.max(Math.abs(a.z),Math.abs(b.z)));return{min:c,max:f}},computeInitialHull:function(){var a,b,c;return function(){void 0===a&&(a=new THREE.Line3,b=new THREE.Plane,c=new THREE.Vector3);var f=this.vertices,d=this.computeExtremes(),e=d.min,h=d.max,k,m,g=0;for(d=m=0;3>d;d++){var n=h[d].point.getComponent(d)-e[d].point.getComponent(d);n>g&&(g=n,m=d)}e=e[m];h=h[m];g=0;a.set(e.point,h.point);d=0;for(k=this.vertices.length;d<k;d++){var r=f[d];if(r!==e&&r!==h&&(a.closestPointToPoint(r.point,
!0,c),n=c.distanceToSquared(r.point),n>g)){g=n;var t=r}}g=-1;b.setFromCoplanarPoints(e.point,h.point,t.point);d=0;for(k=this.vertices.length;d<k;d++)if(r=f[d],r!==e&&r!==h&&r!==t&&(n=Math.abs(b.distanceToPoint(r.point)),n>g)){g=n;var p=r}n=[];if(0>b.distanceToPoint(p.point))for(n.push(A.create(e,h,t),A.create(p,h,e),A.create(p,t,h),A.create(p,e,t)),d=0;3>d;d++)m=(d+1)%3,n[d+1].getEdge(2).setTwin(n[0].getEdge(m)),n[d+1].getEdge(1).setTwin(n[m+1].getEdge(0));else for(n.push(A.create(e,t,h),A.create(p,
e,h),A.create(p,h,t),A.create(p,t,e)),d=0;3>d;d++)m=(d+1)%3,n[d+1].getEdge(2).setTwin(n[0].getEdge((3-d)%3)),n[d+1].getEdge(0).setTwin(n[m+1].getEdge(1));for(d=0;4>d;d++)this.faces.push(n[d]);d=0;for(k=f.length;d<k;d++)if(r=f[d],r!==e&&r!==h&&r!==t&&r!==p){g=this.tolerance;var x=null;for(m=0;4>m;m++)n=this.faces[m].distanceToPoint(r.point),n>g&&(g=n,x=this.faces[m]);null!==x&&this.addVertexToFace(r,x)}return this}}(),reindexFaces:function(){for(var a=[],b=0;b<this.faces.length;b++){var c=this.faces[b];
0===c.mark&&a.push(c)}this.faces=a;return this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var a=0,b=this.assigned.first().face,c=b.outside;do{var f=b.distanceToPoint(c.point);if(f>a){a=f;var d=c}c=c.next}while(null!==c&&c.face===b);return d}},computeHorizon:function(a,b,c,f){this.deleteFaceVertices(c);c.mark=1;c=null===b?b=c.getEdge(0):b.next;do{var d=c.twin,e=d.face;0===e.mark&&(e.distanceToPoint(a)>this.tolerance?this.computeHorizon(a,d,e,f):f.push(c));c=c.next}while(c!==b);return this},
addAdjoiningFace:function(a,b){a=A.create(a,b.tail(),b.head());this.faces.push(a);a.getEdge(-1).setTwin(b.twin);return a.getEdge(0)},addNewFaces:function(a,b){this.newFaces=[];for(var c=null,f=null,d=0;d<b.length;d++){var e=this.addAdjoiningFace(a,b[d]);null===c?c=e:e.next.setTwin(f);this.newFaces.push(e.face);f=e}c.next.setTwin(f);return this},addVertexToHull:function(a){var b=[];this.unassigned.clear();this.removeVertexFromFace(a,a.face);this.computeHorizon(a.point,null,a.face,b);this.addNewFaces(a,
b);this.resolveUnassignedPoints(this.newFaces);return this},cleanup:function(){this.assigned.clear();this.unassigned.clear();this.newFaces=[];return this},compute:function(){var a;for(this.computeInitialHull();void 0!==(a=this.nextVertexToAdd());)this.addVertexToHull(a);this.reindexFaces();this.cleanup();return this}});Object.assign(A,{create:function(a,b,c){var f=new A;a=new J(a,f);b=new J(b,f);c=new J(c,f);a.next=c.prev=b;b.next=a.prev=c;c.next=b.prev=a;f.edge=a;return f.compute()}});Object.assign(A.prototype,
{getEdge:function(a){for(var b=this.edge;0<a;)b=b.next,a--;for(;0>a;)b=b.prev,a++;return b},compute:function(){var a;return function(){void 0===a&&(a=new THREE.Triangle);var b=this.edge.tail(),c=this.edge.head(),f=this.edge.next.head();a.set(b.point,c.point,f.point);a.getNormal(this.normal);a.getMidpoint(this.midpoint);this.area=a.getArea();this.constant=this.normal.dot(this.midpoint);return this}}(),distanceToPoint:function(a){return this.normal.dot(a)-this.constant}});Object.assign(J.prototype,
{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var a=this.head(),b=this.tail();return null!==b?b.point.distanceTo(a.point):-1},lengthSquared:function(){var a=this.head(),b=this.tail();return null!==b?b.point.distanceToSquared(a.point):-1},setTwin:function(a){this.twin=a;a.twin=this;return this}});Object.assign(V.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){this.head=this.tail=null;return this},
insertBefore:function(a,b){b.prev=a.prev;b.next=a;null===b.prev?this.head=b:b.prev.next=b;a.prev=b;return this},insertAfter:function(a,b){b.prev=a;b.next=a.next;null===b.next?this.tail=b:b.next.prev=b;a.next=b;return this},append:function(a){null===this.head?this.head=a:this.tail.next=a;a.prev=this.tail;a.next=null;this.tail=a;return this},appendChain:function(a){null===this.head?this.head=a:this.tail.next=a;for(a.prev=this.tail;null!==a.next;)a=a.next;this.tail=a;return this},remove:function(a){null===
a.prev?this.head=a.next:a.prev.next=a.next;null===a.next?this.tail=a.prev:a.next.prev=a.prev;return this},removeSubList:function(a,b){null===a.prev?this.head=b.next:a.prev.next=b.next;null===b.next?this.tail=a.prev:b.next.prev=a.prev;return this},isEmpty:function(){return null===this.head}});L.prototype=Object.create(THREE.BufferGeometry.prototype);O.prototype=Object.create(THREE.Geometry.prototype);O.prototype.constructor=O;B.prototype=Object.create(THREE.BufferGeometry.prototype);B.prototype.constructor=
B;var e={Ar:null,ArLng:[],ArPos:[],ArMax:0,key:[0,0,0,0,0,0,0,0],constraintDebug:!1,flow:{ray:[],terrain:[],vehicle:[],key:[]},post:null,extraGeo:[],container:null,tmpMat:[],mat:{},geo:{},controler:null,torad:Math.PI/180,isRefView:!1,correctSize:function(a){1===a.length&&(a[1]=a[0]);2===a.length&&(a[2]=a[0]);return a},tmpQ:new THREE.Quaternion,tmpE:new THREE.Euler,tmpM:new THREE.Matrix4,toQuatArray:function(a){return e.tmpQ.setFromEuler(e.tmpE.fromArray(e.vectorad(a))).toArray()},vectorad:function(a){for(var b=
a.length;b--;)a[b]*=e.torad;return a}},q=new Map;Object.assign(W.prototype,{step:function(a,b){var c;this.bodys.forEach(function(f,d){c=b+8*d;d=a[c];if(0<d)"sleep"==f.material.name&&(f.material=e.mat.move),50<d&&"move"==f.material.name?f.material=e.mat.speed:50>d&&"speed"==f.material.name&&(f.material=e.mat.move);else if("move"==f.material.name||"speed"==f.material.name)f.material=e.mat.sleep;f.enabled&&(f.position.fromArray(a,c+1),f.quaternion.fromArray(a,c+4))})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());
for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(a){q.delete(a.name);e.destroy(a)},remove:function(a){if(q.has(a)){a=q.get(a);var b="solid"===a.type?!0:!1,c=b?this.solids.indexOf(a):this.bodys.indexOf(a);-1!==c&&(b?this.solids.splice(c,1):this.bodys.splice(c,1),this.destroy(a))}},add:function(a,b){void 0!==a.density&&(a.mass=a.density);void 0!==a.bounce&&(a.restitution=a.bounce);a.mass=void 0===a.mass?0:a.mass;a.kinematic=a.kinematic||!1;var c="body";0!==a.mass||
a.kinematic||(c="static");a.name=void 0!==a.name?a.name:c+this.ID++;this.remove(a.name);!a.breakable||"hardbox"!==a.type&&"box"!==a.type&&"sphere"!==a.type&&"cylinder"!==a.type&&"cone"!==a.type||(a.type="real"+a.type);var f=!1;a.type=void 0===a.type?"box":a.type;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.size=void 0==a.size?[1,1,1]:a.size;a.size=e.correctSize(a.size);a.geoSize&&(a.geoSize=e.correctSize(a.geoSize));a.quat=void 0===a.quat?[0,0,0,1]:a.quat;void 0!==a.rot&&(a.quat=e.toQuatArray(a.rot),delete a.rot);
c=null;var d=void 0!==a.noMesh?a.noMesh:!1;if("plane"===a.type)e.post("add",a);else{if(void 0!==a.material)var v=a.material.constructor===String?e.mat[a.material]:a.material;else v=0!==a.mass||a.kinematic?e.mat.move:e.mat.static,a.kinematic&&(v=e.mat.kinematic);if("compound"===a.type){for(d=0;d<a.shapes.length;d++){var h=a.shapes[d];h.size=void 0===h.size?[1,1,1]:h.size;1===h.size.length&&(h.size[1]=h.size[0]);2===h.size.length&&(h.size[2]=h.size[0]);h.pos=void 0===h.pos?[0,0,0]:h.pos;h.rot=void 0===
h.rot?[0,0,0]:e.vectorad(h.rot);h.quat=void 0===h.quat?(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(h.rot)).toArray():h.quat}c=a.geometry?new THREE.Mesh(a.geometry,v):new THREE.Group;a.geometry&&e.extraGeo.push(a.geometry);if(!a.geometry||a.debug)for(c.material=v,d=0;d<a.shapes.length;d++){h=a.shapes[d];var k=null;"capsule"===h.type?k=new L(a.size[0],a.size[1]):"convex"===h.type?(k=h.shape,h.v=K(h.shape,h.type),delete h.shape):k=e.geo[h.type];"capsule"!==h.type&&"convex"!==h.type||
e.extraGeo.push(k);k=new THREE.Mesh(k,a.debug?e.mat.debug:v);k.scale.fromArray(h.size);k.position.fromArray(h.pos);k.quaternion.fromArray(h.quat);c.add(k)}}else if("mesh"===a.type||"convex"===a.type)f=!0,a.shape&&(a.v=K(a.shape,a.type),e.extraGeo.push(a.shape)),a.geometry?(a.geoScale&&(a.geometry=a.geometry.clone(),a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],a.geoScale[0],a.geoScale[0]))),c=new THREE.Mesh(a.geometry,v),e.extraGeo.push(a.geometry)):d||(c=new THREE.Mesh(a.shape,
v));else{"capsule"===a.type&&(a.geometry=new L(a.size[0],a.size[1]));if("realbox"===a.type||"realhardbox"===a.type)a.geometry=new THREE.BoxBufferGeometry(a.size[0],a.size[1],a.size[2]);"realsphere"===a.type&&(a.geometry=new THREE.SphereBufferGeometry(a.size[0],16,12));"realcylinder"===a.type&&(a.geometry=new THREE.CylinderBufferGeometry(a.size[0],a.size[0],.5*a.size[1],12,1));"realcone"===a.type&&(a.geometry=new THREE.CylinderBufferGeometry(0,.5*a.size[0],.55*a.size[1],12,1));void 0!==a.radius&&e.isRefView&&
("box"===a.type&&(a.geometry=new THREE.ChamferBox(a.size[0],a.size[1],a.size[2],a.radius)),"cylinder"===a.type&&(a.geometry=new THREE.ChamferCyl(a.size[0],a.size[0],.5*a.size[1],a.radius)),"cone"===a.type&&(a.geometry=new THREE.ChamferCyl(a.radius,a.size[0],.5*a.size[1],a.radius)));if(a.geometry){if(a.geoRot||a.geoScale)a.geometry=a.geometry.clone();a.geoRot&&a.geometry.applyMatrix((new THREE.Matrix4).makeRotationFromEuler((new THREE.Euler).fromArray(e.vectorad(a.geoRot))));a.geoScale&&a.geometry.applyMatrix((new THREE.Matrix4).makeScale(a.geoScale[0],
a.geoScale[1],a.geoScale[2]))}c=new THREE.Mesh(a.geometry||e.geo[a.type],v);a.geometry&&(e.extraGeo.push(a.geometry),a.geoSize&&c.scale.fromArray(a.geoSize),f=!0)}"highsphere"===a.type&&(a.type="sphere");if("isGeometry"==b)return h;c&&(f||c.isGroup||(c.scale.fromArray(a.size),b=c,c=new THREE.Group,c.add(b)),a.mesh&&(c=new THREE.Group,c.add(a.mesh)),c.position.fromArray(a.pos),c.quaternion.fromArray(a.quat),c.updateMatrix(),c.name=a.name,c.enabled=!0,void 0!==a.parent?(a.parent.add(c),a.parent=null):
e.container.add(c),void 0===a.noShadow&&(c.isGroup&&(Object.defineProperty(c,"receiveShadow",{get:function(){return this.children[0].receiveShadow},set:function(a){for(var b=this.children.length;b--;)this.children[b].receiveShadow=a}}),Object.defineProperty(c,"castShadow",{get:function(){return this.children[0].castShadow},set:function(a){for(var b=this.children.length;b--;)this.children[b].castShadow=a}})),c.receiveShadow=!0,c.castShadow=0!==a.mass||a.kinematic?!0:!1));a.shape&&delete a.shape;a.geometry&&
delete a.geometry;a.material&&delete a.material;a.mesh&&delete a.mesh;void 0===a.noPhy&&(c&&(0!==a.mass||a.kinematic?this.bodys.push(c):this.solids.push(c)),e.post("add",a));if(c)return c.type=0!==a.mass||a.kinematic?"body":"solid",c.userData.mass=a.mass,q.set(a.name,c),void 0!==a.autoMatrix&&(c.matrixAutoUpdate=a.autoMatrix),c}}});Object.assign(X.prototype,{step:function(a,b){if(e.constraintDebug){var c;this.joints.forEach(function(f,d){c=b+14*d;f.step(c,a)})}},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());
this.ID=0},destroy:function(a){q.delete(a.name);a.clear()},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.joints.indexOf(a);this.joints.splice(b,1);this.destroy(a)}},add:function(a){a.name=void 0!==a.name?a.name:"joint"+this.ID++;this.remove(a.name);var b=new Y(a);this.joints.push(b);q.set(b.name,b);void 0!==a.parent&&(a.parent=null);e.post("add",a);return b}});Object.assign(Y.prototype,{step:function(a,b){if(this.isMesh){this.mesh.visible||(this.mesh.visible=!0);var c=this.pos.array;c[0]=
b[a];c[1]=b[a+1];c[2]=b[a+2];c[3]=b[a+7];c[4]=b[a+8];c[5]=b[a+9];this.pos.needsUpdate=!0;this.p1.position.fromArray(b,a);this.p1.quaternion.fromArray(b,a+3);this.p2.position.fromArray(b,a+7);this.p2.quaternion.fromArray(b,a+10)}},init:function(a){var b=new Float32Array([0,0,0,0,0,0]),c=new Float32Array([0,1,0,1,1,0]),f=new THREE.BufferGeometry;f.setAttribute("position",new THREE.BufferAttribute(b,3));f.setAttribute("color",new THREE.BufferAttribute(c,3));this.mesh=new THREE.Line(f,e.mat.jointLine);
this.mesh.name=a.name;this.p1=new THREE.Mesh(e.geo.joint,e.mat.jointP1);this.p2=new THREE.Mesh(e.geo.joint,e.mat.jointP2);this.p1.receiveShadow=!1;this.p1.castShadow=!1;this.p2.receiveShadow=!1;this.p2.castShadow=!1;this.mesh.receiveShadow=!1;this.mesh.castShadow=!1;this.mesh.add(this.p1);this.mesh.add(this.p2);this.mesh.frustumCulled=!1;this.pos=this.mesh.geometry.attributes.position;this.mesh.visible=!1;void 0!==a.parent?(a.parent.add(this.mesh),a.parent=null):e.container.add(this.mesh);this.isMesh=
!0},clear:function(){this.isMesh&&(this.mesh.geometry.dispose(),e.destroy(this.mesh),this.p2=this.p1=this.mesh=null,this.isMesh=!1)}});Object.assign(Z.prototype,{step:function(a,b){var c=b;this.softs.forEach(function(b){var d,f,e=b.geometry,k=b.softType,g=null,q=e.attributes.color?!0:!1,n=e.attributes.normal?!0:!1;if(2===k){for(f=e.positions.length;f--;){var r=c+3*f;e.positions[f].set(a[r],a[r+1],a[r+2])}e.updatePath()}else{if(!e.attributes.position)return;var t=e.attributes.position.array;if(q)var p=
e.attributes.color.array;if(5===k||4===k){var x=e.numVertices,y=e.maxi,z=e.pPoint,w=e.lPoint;for(f=x;f--;){r=3*f+c;var l=f==x-1?y-z[f]:z[f+1]-z[f];for(d=z[f];l--;)p=3*w[d+l],t[p]=a[r],t[p+1]=a[r+1],t[p+2]=a[r+2]}}else if(e.attributes.order&&(g=e.attributes.order.array),f=t.length,r=2,null!==g)for(f=g.length;f--;)l=3*g[f],r=3*f+c,t[l]=a[r],t[l+1]=a[r+1],t[l+2]=a[r+2],d=Math.abs(a[r+1]/10),p[l]=d,p[l+1]=d,p[l+2]=d;else for(;f--;)t[f]=a[f+c],1==r&&(d=Math.abs(t[f]/10),p[f-1]=d,p[f]=d,p[f+1]=d),r--,r=
0>r?2:r;2!==k&&e.computeVertexNormals();if(n){r=e.attributes.normal.array;for(f=x;f--;)for(l=f==x-1?y-z[f]:z[f+1]-z[f],d=z[f],t=3*w[d];l--;)p=3*w[d+l],r[p]=r[t],r[p+1]=r[t+1],r[p+2]=r[t+2];e.attributes.normal.needsUpdate=!0}q&&(e.attributes.color.needsUpdate=!0);e.attributes.position.needsUpdate=!0;e.computeBoundingSphere()}c+=3*b.points})},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=
q.get(a);var b=this.softs.indexOf(a);-1!==b&&(this.softs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.pos=void 0===a.pos?[0,0,0]:a.pos;a.size=void 0==a.size?[1,1,1]:a.size;a.size=e.correctSize(a.size);a.quat=void 0===a.quat?[0,0,0,1]:a.quat;void 0!==a.rot&&(a.quat=e.toQuatArray(a.rot),delete a.rot);var c=void 0!==a.material?a.material.constructor===String?e.mat[a.material]:a.material:e.mat.soft;switch(a.type){case "softMesh":case "softTriMesh":var f=
aa(a,c);break;case "softConvex":f=aa(a,c);break;case "softCloth":f=a.div||[16,16];var d=a.size||[100,0,100],v=a.pos||[0,0,0],h=f[0]*f[1],k=new THREE.PlaneBufferGeometry(d[0],d[2],f[0]-1,f[1]-1);k.setAttribute("color",new THREE.BufferAttribute(new Float32Array(3*h),3));k.rotateX(-Math.PI90);c=new THREE.Mesh(k,c);c.position.set(v[0],v[1],v[2]);c.castShadow=!0;c.receiveShadow=!0;c.softType=1;c.points=k.attributes.position.array.length/3;a.size=d;a.div=f;a.pos=v;f={mesh:c,o:a};break;case "softRope":void 0===
a.numSeg&&(a.numSeg=a.numSegment);f=new THREE.Tubular(a,a.numSeg||10,a.radius||.2,a.numRad||6,!1);c=new THREE.Mesh(f,c);c.castShadow=!0;c.receiveShadow=!0;c.softType=2;c.points=f.positions.length;f={mesh:c,o:a};break;case "softEllips":this.tmpMat=c;e.post("add",a);return}c=f.mesh;a=f.o;c.name=b;c.type="soft";e.container.add(c);this.softs.push(c);q.set(b,c);e.post("add",a)},createEllipsoid:function(a){var b=a.lng,c=[],f=a.a,d,v;for(d=0;d<b;d++){var h=3*d;c.push(new THREE.Vector3(f[h],f[h+1],f[h+2]))}c=
new O(c);var k=new Uint32Array(3*c.faces.length),g=new Float32Array(3*b),Q=new Float32Array(b);var n=c.vertices;for(d=b;d--;)for(v=b;v--;)h=3*v,f[h]==n[d].x&&f[h+1]==n[d].y&&f[h+2]==n[d].z&&(Q[v]=d);for(d=b;d--;)h=3*d,v=3*Q[d],g[v]=f[h],g[v+1]=f[h+1],g[v+2]=f[h+2];for(d=c.faces.length;d--;)h=3*d,f=c.faces[d],k[h]=f.a,k[h+1]=f.b,k[h+2]=f.c;d=new THREE.BufferGeometry;d.setIndex(new THREE.BufferAttribute(k,1));d.setAttribute("position",new THREE.BufferAttribute(g,3));d.setAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
b),3));d.setAttribute("order",new THREE.BufferAttribute(Q,1));c.uvs&&(b=new Float32Array(2*c.uvs.length),d.setAttribute("uv",(new THREE.BufferAttribute(b,2)).copyVector2sArray(c.uvs),2));d.computeVertexNormals();e.extraGeo.push(d);c.dispose();b=new THREE.Mesh(d,e.mat.soft);b.softType=3;b.type="soft";b.points=d.attributes.position.array.length/3;b.castShadow=!0;b.receiveShadow=!0;this.tmpMat&&(b.material=this.tmpMat);b.name=a.name;e.container.add(b);this.softs.push(b);q.set(a.name,b)}});Object.assign(ba.prototype,
{step:function(){e.flow.terrain=[];this.terrains.forEach(function(a){a.needsUpdate&&(a.updateGeometry(),e.flow.terrain.push({name:a.name,heightData:a.heightData}),a.needsUpdate=!1)})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.terrains.indexOf(a);-1!==b&&(this.terrains.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==
a.name?a.name:a.type+this.ID++;this.remove(b);a.sample=void 0===a.sample?[64,64]:a.sample;a.pos=void 0===a.pos?[0,0,0]:a.pos;a.complexity=void 0===a.complexity?30:a.complexity;a.name=b;var c=new THREE.Terrain(a);c.needsUpdate=!1;c.type="terrain";a.heightData=c.heightData;a.offset=0;e.container.add(c);this.terrains.push(c);q.set(b,c);e.post("add",a)},move:function(a,b,c){q.has(a)&&(a=q.get(a),a.local.x+=b||0,a.local.z+=c||0,a.update(!0),a.needsUpdate=!0)}});Object.assign(ca.prototype,{step:function(a,
b){var c;this.cars.forEach(function(f,d){var e=f.userData.NumWheels,h=56;c=b+64*d;f.userData.speed=a[c];f.userData.wr=[a[c+62],a[c+63]];f.position.fromArray(a,c+1);f.quaternion.fromArray(a,c+4);var k=f.userData.radius;d=a[c+8];f.userData.steering=d;f.userData.steeringWheel&&(f.userData.steeringWheel.rotation.y=15*-d);if(f.userData.isWithBrake){var g=a[c+8],q=a[c+16];for(d=e;d--;)0===d&&(f.userData.b[d].rotation.y=q),1===d&&(f.userData.b[d].rotation.y=Math.Pi-g),f.userData.b[d].position.y=k-a[c+h+
d]}if(f.userData.isWithSusp)for(d=e;d--;)k=5*a[c+h+d],k=1<k?1:k,k=-1>k?-1:k,0<k?(f.userData.s[d].setWeight("low",k),f.userData.s[d].setWeight("top",0)):(f.userData.s[d].setWeight("low",0),f.userData.s[d].setWeight("top",-k));f.userData.helper&&(2===e&&f.userData.helper.updateSuspension(a[c+h+0],a[c+h+0],a[c+h+1],a[c+h+1]),4===e&&f.userData.helper.updateSuspension(a[c+h+0],a[c+h+1],a[c+h+2],a[c+h+3]));for(;e--;)f.userData.suspension[e]=a[c+56+e],h=8*(e+1),f.userData.w[e].position.fromArray(a,c+h+1),
f.userData.w[e].quaternion.fromArray(a,c+h+4)})},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(a){for(var b,c=0,f=a.userData.w.length;c<f;c++)b=a.userData.w[c],b.parent&&b.parent.remove(b);a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.cars.indexOf(a);-1!==b&&(this.cars.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);var c=a.size||
[2,.5,4],f=a.pos||[0,0,0],d=a.rot||[0,0,0];a.masscenter=void 0===a.masscenter?[0,0,0]:a.masscenter;Math.vectorad(d);a.mesh?(c=new THREE.Group,c.add(a.mesh)):a.geometry?(c=new THREE.Mesh(a.geometry,a.material),e.extraGeo.push(a.geometry)):(c=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(c[0],c[1],c[2])),c.translate(-a.masscenter[0],-a.masscenter[1],-a.masscenter[2]),e.extraGeo.push(c),c=new THREE.Mesh(c,e.mat.move));a.debug&&a.shape&&(c=new THREE.Mesh(a.shape,e.mat.debug));c.position.set(f[0],
f[1],f[2]);c.rotation.set(d[0],d[1],d[2]);a.quat=c.quaternion.toArray();e.container.add(c);c.userData.speed=0;c.userData.NumWheels=a.nWheel||4;c.userData.suspension=[0,0,0,0,0,0];c.userData.wr=[0,0];c.userData.steering=0;c.userData.type="car";c.userData.steeringWheel=a.meshSteeringWheel||null;d=a.radius||.4;var g=a.radiusBack||d,h=a.deep||.3;f=a.wPos||[1,-.25,1.6];var k=[],m=[],Q=[],n=void 0===a.meshSusp?!1:!0,r=void 0===a.meshBrake?!1:!0,t=void 0==a.wheel?!0:!1,p=a.wheel||e.geo.wheel,x=p.clone();
x.rotateY(Math.Pi);e.extraGeo.push(x);var y=e.mat.move;void 0!==a.wheelMaterial&&(y=a.wheelMaterial.constructor===String?e.mat[a.wheelMaterial]:a.wheelMaterial);for(var z=a.nWheel||4,w,l=0;l<z;l++){0===l&&(w=!0);1===l&&(w=!0);2===l&&(w=!1);3===l&&(w=!1);4===l&&(w=!1);5===l&&(w=!1);2===z&&(0===l&&(w=!0),1===l&&(w=!1));3===z&&(0===l&&(w=!0),1===l&&(w=!1),2===l&&(w=!1));if(a.meshBrake){var u=a.meshBrake.clone();c.add(u);u.position.y=d;1==l||2==l?(u.rotation.y=Math.Pi,u.position.x=f[0],u.rotation.x=Math.Pi):
u.position.x=-f[0];u.position.z=0==l||1==l?f[2]:-f[2];Q[l]=u}if(a.meshSusp){u=a.meshSusp.clone();c.add(u);u.position.y=d;if(1==l||2==l)u.rotation.y=Math.Pi;u.position.z=0==l||1==l?f[2]:-f[2];m[l]=u.children[0]}if(a.meshWheel)if(k[l]=a.meshWheel.clone(),t=!1,1==l||2==l)k[l]=new THREE.Group,u=a.meshWheel.clone(),u.rotation.y=Math.Pi,k[l].add(u);else for(k[l]=a.meshWheel.clone(),u=k[l].children.length;u--;)"h_pneu"===k[l].children[u].name&&(k[l].children[u].rotation.y=Math.Pi);else k[l]=1==l||2==l?new THREE.Mesh(p,
e.mat.move):new THREE.Mesh(x,e.mat.move);t&&k[l].scale.set(h,w?d:g,w?d:g);k[l].material=y;k[l].castShadow=!0;k[l].receiveShadow=!0;e.container.add(k[l])}a.extraWeels&&(w=a.meshWheel.clone(),w.children[0].visible=!1,w.rotation.z=.5*-Math.Pi,w.position.set(0,1.25,-1.11),c.add(w));c.userData.radius=d;c.userData.w=k;c.userData.s=m;c.userData.b=Q;c.userData.isWithSusp=n;c.userData.isWithBrake=r;void 0===a.noShadow&&(c.castShadow=!0,c.receiveShadow=!0);c.name=b;a.helper&&(c.userData.helper=new THREE.CarHelper(f,
a.masscenter,h),c.add(c.userData.helper));a.mesh&&(a.mesh=null);a.wheel&&(a.wheel=null);if("mesh"==a.shapeType||"convex"==a.shapeType)a.v=K(a.shape,a.shapeType);a.shape&&delete a.shape;a.geometry&&delete a.geometry;a.material&&delete a.material;a.mesh&&delete a.mesh;a.meshWheel&&delete a.meshWheel;a.meshSusp&&delete a.meshSusp;a.meshBrake&&delete a.meshBrake;a.meshSteeringWheel&&delete a.meshSteeringWheel;a.wheelMaterial&&delete a.wheelMaterial;this.cars.push(c);q.set(b,c);e.post("add",a)}});Object.assign(da.prototype,
{step:function(a,b){var c;this.heroes.forEach(function(f,d){c=b+8*d;d=3.33*a[c];f.userData.speed=100*d;f.position.fromArray(a,c+1);f.quaternion.fromArray(a,c+4);f.skin&&(0===d?f.skin.play(0,.3):(f.skin.play(1,.3),f.skin.setTimeScale(d)))})},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.heroes.indexOf(a);-1!==b&&(this.heroes.splice(b,1),this.destroy(a))}},
add:function(a){var b=void 0!==a.name?a.name:a.type+this.ID++;this.remove(b);a.scale=a.scale||1;a.size=void 0!==a.size?a.size:[.25,2];if(a.mesh){var c=a.mesh.geometry,f=-(Math.abs(c.boundingBox.max.y)-Math.abs(c.boundingBox.min.y))*a.scale*.5;a.size[1]=(Math.abs(c.boundingBox.max.y)+Math.abs(c.boundingBox.min.y))*a.scale}a.size[1]-=2*a.size[0];a.pos=void 0===a.pos?[0,0,0]:a.pos;a.rot=void 0==a.rot?[0,0,0]:Math.vectorad(a.rot);a.quat=(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray(a.rot)).toArray();
var d=void 0!==a.material?a.material.constructor===String?e.mat[a.material]:a.material:e.mat.hero;var g=new L(a.size[0],a.size[1],6);c=new THREE.Group;if(a.debug){var h=new THREE.Mesh(g,e.mat.debug);e.extraGeo.push(g);c.add(h)}a.mesh?(g=a.mesh,g.material=d,g.scale.multiplyScalar(a.scale),g.position.set(0,f,0),g.setTimeScale(.5),g.play(0),c.add(g),c.skin=g):(f=new THREE.Mesh(g,d),e.extraGeo.push(g),c.add(f));c.userData.speed=0;c.userData.type="hero";c.position.fromArray(a.pos);c.quaternion.fromArray(a.quat);
c.castShadow=!0;c.receiveShadow=!0;c.name=b;a.material&&delete a.material;a.mesh&&delete a.mesh;a.scale&&delete a.scale;e.container.add(c);this.heroes.push(c);q.set(b,c);e.post("add",a);return c}});Object.assign(ea.prototype,{step:function(a,b){this.pairs.forEach(function(c,f){c.hit=a[b+f]?a[b+f]:0;c.callback(a[b+f]||0)})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(a){a.clear();q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);
var b=this.pairs.indexOf(a);-1!==b&&(this.pairs.splice(b,1),this.destroy(a))}},add:function(a){var b=void 0!==a.name?a.name:"pair"+this.ID++;this.remove(b);var c=new fa(b,a.callback);this.pairs.push(c);delete a.callback;q.set(b,c);e.post("add",a);return c}});Object.assign(fa.prototype,{clear:function(){this.name=null;this.hit=0;this.callback=null}});Object.assign(ha.prototype,{step:function(){var a=this.rays.length,b=e.flow.ray.length;if(a){if(a===b)for(;b--;)this.rays[b].update(e.flow.ray[b]);e.flow.ray=
[];this.rays.forEach(function(a,b){a.updateMatrixWorld();e.flow.ray.push({origin:a.origin,dest:a.dest,group:a.group,mask:a.mask,precision:a.precision})})}},clear:function(){for(;0<this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(a){a.parent&&a.parent.remove(a);q.delete(a.name)},remove:function(a){if(q.has(a)){a=q.get(a);var b=this.rays.indexOf(a);-1!==b&&(this.rays.splice(b,1),this.destroy(a))}},add:function(a){a.name=void 0!==a.name?a.name:"ray"+this.ID++;this.remove(a.name);
var b=new ia(a);void 0!==a.visible&&(b.visible=a.visible);void 0!==a.parent?a.parent.add(b):e.container.add(b);this.rays.push(b);q.set(a.name,b);delete a.callback;delete a.parent;e.post("add",a);return b}});ia.prototype=Object.assign(Object.create(THREE.Line.prototype),{setFromCamera:function(a,b){b&&b.isPerspectiveCamera?(this.start.setFromMatrixPosition(b.matrixWorld),this.tmp.set(a.x,a.y,.5).unproject(b).sub(this.start).normalize(),this.end.copy(this.tmp).multiplyScalar(b.far).add(this.start)):
b&&b.isOrthographicCamera?(this.start.set(a.x,a.y,(b.near+b.far)/(b.near-b.far)).unproject(b),this.normal.set(0,0,-1).transformDirection(b.matrixWorld),this.end.addScaledVector(this.normal,b.far)):console.error("THREE.Raycaster: Unsupported camera type.")},updateMatrixWorld:function(a){THREE.Line.prototype.updateMatrixWorld.call(this,a);this.tmp.copy(this.start).applyMatrix4(this.matrixWorld);this.tmp.toArray(this.origin,0);this.tmp.copy(this.end).applyMatrix4(this.matrixWorld);this.tmp.toArray(this.dest,
0);this.inv.getInverse(this.matrixWorld)},upGeo:function(a){if(this.enabled){var b=this.vertices,c=this.colors,f=this.local;if(a)this.isBase=!1,c[0]=c[3]=c[15]=c[18]=this.c2[0],c[1]=c[4]=c[16]=c[19]=this.c2[1],c[2]=c[5]=c[17]=c[20]=this.c2[2],b[3]=b[6]=b[12]=b[15]=f[0],b[4]=b[7]=b[13]=b[16]=f[1],b[5]=b[8]=b[14]=b[17]=f[2],b[18]=f[3],b[19]=f[4],b[20]=f[5],this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0;else if(!this.isBase){for(var d=7;d--;)a=3*d,f=3>
d?!0:!1,c[a]=this.c1[0],c[a+1]=this.c1[1],c[a+2]=this.c1[2],b[a]=f?this.start.x:this.end.x,b[a+1]=f?this.start.y:this.end.y,b[a+2]=f?this.start.z:this.end.z;this.geometry.attributes.position.needsUpdate=!0;this.isBase=this.geometry.attributes.color.needsUpdate=!0}}},update:function(a){this.info.hit=a.hit;this.info.name=a.name||"";this.info.distance=0;if(a.hit){if(this.enabled){this.tmp.fromArray(a.point).applyMatrix4(this.inv);var b=this.tmp.distanceTo(this.end);a.distance=this.maxDistance-b;this.info.distance=
a.distance;this.tmp.toArray(this.local,0);this.normal.fromArray(a.normal);this.tmp.addScaledVector(this.normal,b);this.tmp.toArray(this.local,3);this.upGeo(!0)}}else this.upGeo();this.callback(a)}});D.prototype={constructor:D,prepareBreakableObject:function(a,b,c,f,d){a.geometry.isBufferGeometry||console.error("ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");a=a.userData;a.mass=b;a.velocity=void 0!==c?c.clone():new THREE.Vector3;a.angularVelocity=void 0!==
f?f.clone():new THREE.Vector3;a.breakable=d},subdivideByImpact:function(a,b,c,f,d){function e(b,c,d,k){if(Math.random()<.05*k||k>r)h.push(b);else{var v=Math.PI;0===k?(n.normal.copy(q.normal),n.constant=q.constant):k<=f?(v=(d-c)*(.2+.6*Math.random())+c,t.tempVector3_2.copy(a.position).sub(g).applyAxisAngle(m,v).add(g),n.setFromCoplanarPoints(g,t.tempVector3,t.tempVector3_2)):(v=(.5*(k&1)+.2*(2-Math.random()))*Math.PI,t.tempVector3_2.copy(g).sub(b.position).applyAxisAngle(m,v).add(b.position),t.tempVector3_3.copy(m).add(b.position),
n.setFromCoplanarPoints(b.position,t.tempVector3_3,t.tempVector3_2));t.cutByPlane(b,n,t.tempResultObjects);b=t.tempResultObjects.object1;var l=t.tempResultObjects.object2;b&&e(b,c,v,k+1);l&&e(l,v,d,k+1)}}var h=[],g=(new THREE.Vector3).fromArray(b),m=(new THREE.Vector3).fromArray(c),q=this.tempPlane1,n=this.tempPlane2;this.tempVector3.addVectors(g,m);q.setFromCoplanarPoints(g,a.position,this.tempVector3);var r=d+f,t=this;e(a,0,2*Math.PI,0);return h},cutByPlane:function(a,b,c){function f(a,b){a=3*a+
b;return q?q[a]:a}var d=a.geometry;if(!d)return console.log(a,"no geometry ?"),0;var e=d.attributes.position.array,h=d.attributes.normal.array,g=e.length/3,m=g/3,q=d.getIndex();q&&(q=q.array,m=q.length/3);d=[];for(var n=[],r=this.smallDelta,t=g*g,p=0;p<t;p++)this.segments[p]=!1;t=this.tempVector3_P0;var x=this.tempVector3_P1,y=this.tempVector3_N0,z=this.tempVector3_N1;for(p=0;p<m-1;p++){var w=f(p,0),l=f(p,1),u=f(p,2);y.set(h[w],h[w]+1,h[w]+2);for(var A=p+1;A<m;A++){var E=f(A,0),F=f(A,1),G=f(A,2);
z.set(h[E],h[E]+1,h[E]+2);if(1-y.dot(z)<r)if(w===E||w===F||w===G)l===E||l===F||l===G?(this.segments[w*g+l]=!0,this.segments[l*g+w]=!0):(this.segments[u*g+w]=!0,this.segments[w*g+u]=!0);else if(l===E||l===F||l===G)this.segments[u*g+l]=!0,this.segments[l*g+u]=!0}}h=this.tempPlane_Cut;a.updateMatrix();D.transformPlaneToLocalSpace(b,a.matrix,h);for(p=0;p<m;p++)for(b=f(p,0),y=f(p,1),z=f(p,2),w=0;3>w;w++)if(l=0===w?b:1===w?y:z,u=0===w?y:1===w?z:b,!this.segments[l*g+u]&&(this.segments[l*g+u]=!0,this.segments[u*
g+l]=!0,t.set(e[3*l],e[3*l+1],e[3*l+2]),x.set(e[3*u],e[3*u+1],e[3*u+2]),l=0,u=h.distanceToPoint(t),u>r?(l=2,n.push(t.clone())):u<-r?(l=1,d.push(t.clone())):(l=3,d.push(t.clone()),n.push(t.clone())),u=0,u=h.distanceToPoint(x),u>r?(u=2,n.push(x.clone())):u<-r?(u=1,d.push(x.clone())):(u=3,d.push(x.clone()),n.push(x.clone())),1===l&&2===u||2===l&&1===u)){this.tempLine1.start.copy(t);this.tempLine1.end.copy(x);l=new THREE.Vector3;l=h.intersectLine(this.tempLine1,l);if(void 0===l)return console.error("Internal error: segment does not intersect plane."),
c.segmentedObject1=null,c.segmentedObject2=null,0;d.push(l);n.push(l.clone())}e=.5*a.userData.mass;this.tempCM1.set(0,0,0);g=0;m=d.length;if(0<m){for(p=0;p<m;p++)this.tempCM1.add(d[p]);this.tempCM1.divideScalar(m);for(p=0;p<m;p++)x=d[p],x.sub(this.tempCM1),g=Math.max(g,x.x,x.y,x.z);this.tempCM1.add(a.position)}this.tempCM2.set(0,0,0);r=0;t=n.length;if(0<t){for(p=0;p<t;p++)this.tempCM2.add(n[p]);this.tempCM2.divideScalar(t);for(p=0;p<t;p++)x=n[p],x.sub(this.tempCM2),r=Math.max(r,x.x,x.y,x.z);this.tempCM2.add(a.position)}x=
p=null;b=0;4<m&&(p=new THREE.Mesh(new B(d),a.material),p.position.copy(this.tempCM1),p.quaternion.copy(a.quaternion),this.prepareBreakableObject(p,e,a.userData.velocity,a.userData.angularVelocity,2*g>this.minSizeForBreak),b++);4<t&&(x=new THREE.Mesh(new B(n),a.material),x.position.copy(this.tempCM2),x.quaternion.copy(a.quaternion),this.prepareBreakableObject(x,e,a.userData.velocity,a.userData.angularVelocity,2*r>this.minSizeForBreak),b++);c.object1=p;c.object2=x;return b}};D.transformFreeVector=function(a,
b){var c=a.x,f=a.y,d=a.z;b=b.elements;a.x=b[0]*c+b[4]*f+b[8]*d;a.y=b[1]*c+b[5]*f+b[9]*d;a.z=b[2]*c+b[6]*f+b[10]*d;return a};D.transformFreeVectorInverse=function(a,b){var c=a.x,f=a.y,d=a.z;b=b.elements;a.x=b[0]*c+b[1]*f+b[2]*d;a.y=b[4]*c+b[5]*f+b[6]*d;a.z=b[8]*c+b[9]*f+b[10]*d;return a};D.transformTiedVectorInverse=function(a,b){var c=a.x,f=a.y,d=a.z;b=b.elements;a.x=b[0]*c+b[1]*f+b[2]*d-b[12];a.y=b[4]*c+b[5]*f+b[6]*d-b[13];a.z=b[8]*c+b[9]*f+b[10]*d-b[14];return a};D.transformPlaneToLocalSpace=function(){var a=
new THREE.Vector3;return function(b,c,f){f.normal.copy(b.normal);f.constant=b.constant;b=D.transformTiedVectorInverse(b.coplanarPoint(a),c);D.transformFreeVectorInverse(f.normal,c);f.constant=-b.dot(f.normal)}}();var la=function(){var a=a||{};a.OutWindow=function(){this._windowSize=0};a.OutWindow.prototype.create=function(a){this._buffer&&this._windowSize===a||(this._buffer=[]);this._windowSize=a;this._streamPos=this._pos=0};a.OutWindow.prototype.flush=function(){var a=this._pos-this._streamPos;if(0!==
a){for(;a--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0);this._streamPos=this._pos}};a.OutWindow.prototype.releaseStream=function(){this.flush();this._stream=null};a.OutWindow.prototype.setStream=function(a){this.releaseStream();this._stream=a};a.OutWindow.prototype.init=function(a){a||(this._pos=this._streamPos=0)};a.OutWindow.prototype.copyBlock=function(a,c){a=this._pos-a-1;for(0>a&&(a+=this._windowSize);c--;)a>=this._windowSize&&(a=0),this._buffer[this._pos++]=
this._buffer[a++],this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.putByte=function(a){this._buffer[this._pos++]=a;this._pos>=this._windowSize&&this.flush()};a.OutWindow.prototype.getByte=function(a){a=this._pos-a-1;0>a&&(a+=this._windowSize);return this._buffer[a]};a.RangeDecoder=function(){};a.RangeDecoder.prototype.setStream=function(a){this._stream=a};a.RangeDecoder.prototype.releaseStream=function(){this._stream=null};a.RangeDecoder.prototype.init=function(){var a=5;this._code=
0;for(this._range=-1;a--;)this._code=this._code<<8|this._stream.readByte()};a.RangeDecoder.prototype.decodeDirectBits=function(a){for(var b=0,f;a--;)this._range>>>=1,f=this._code-this._range>>>31,this._code-=this._range&f-1,b=b<<1|1-f,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return b};a.RangeDecoder.prototype.decodeBit=function(a,c){var b=a[c],d=(this._range>>>11)*b;if((this._code^2147483648)<(d^2147483648))return this._range=d,a[c]+=2048-b>>>
5,0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0;this._range-=d;this._code-=d;a[c]-=b>>>5;0===(this._range&4278190080)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return 1};a.initBitModels=function(a,c){for(;c--;)a[c]=1024};a.BitTreeDecoder=function(a){this._models=[];this._numBitLevels=a};a.BitTreeDecoder.prototype.init=function(){a.initBitModels(this._models,1<<this._numBitLevels)};a.BitTreeDecoder.prototype.decode=function(a){for(var b=
1,f=this._numBitLevels;f--;)b=b<<1|a.decodeBit(this._models,b);return b-(1<<this._numBitLevels)};a.BitTreeDecoder.prototype.reverseDecode=function(a){for(var b=1,f=0,d=0,e;d<this._numBitLevels;++d)e=a.decodeBit(this._models,b),b=b<<1|e,f|=e<<d;return f};a.reverseDecode2=function(a,c,f,d){for(var b=1,e=0,g=0,m;g<d;++g)m=f.decodeBit(a,c+b),b=b<<1|m,e|=m<<g;return e};a.LenDecoder=function(){this._choice=[];this._lowCoder=[];this._midCoder=[];this._highCoder=new a.BitTreeDecoder(8);this._numPosStates=
0};a.LenDecoder.prototype.create=function(b){for(;this._numPosStates<b;++this._numPosStates)this._lowCoder[this._numPosStates]=new a.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new a.BitTreeDecoder(3)};a.LenDecoder.prototype.init=function(){var b=this._numPosStates;for(a.initBitModels(this._choice,2);b--;)this._lowCoder[b].init(),this._midCoder[b].init();this._highCoder.init()};a.LenDecoder.prototype.decode=function(a,c){return 0===a.decodeBit(this._choice,0)?this._lowCoder[c].decode(a):
0===a.decodeBit(this._choice,1)?8+this._midCoder[c].decode(a):16+this._highCoder.decode(a)};a.Decoder2=function(){this._decoders=[]};a.Decoder2.prototype.init=function(){a.initBitModels(this._decoders,768)};a.Decoder2.prototype.decodeNormal=function(a){var b=1;do b=b<<1|a.decodeBit(this._decoders,b);while(256>b);return b&255};a.Decoder2.prototype.decodeWithMatchByte=function(a,c){var b=1;do{var d=c>>7&1;c<<=1;var e=a.decodeBit(this._decoders,(1+d<<8)+b);b=b<<1|e;if(d!==e){for(;256>b;)b=b<<1|a.decodeBit(this._decoders,
b);break}}while(256>b);return b&255};a.LiteralDecoder=function(){};a.LiteralDecoder.prototype.create=function(b,c){if(!this._coders||this._numPrevBits!==c||this._numPosBits!==b)for(this._numPosBits=b,this._posMask=(1<<b)-1,this._numPrevBits=c,this._coders=[],b=1<<this._numPrevBits+this._numPosBits;b--;)this._coders[b]=new a.Decoder2};a.LiteralDecoder.prototype.init=function(){for(var a=1<<this._numPrevBits+this._numPosBits;a--;)this._coders[a].init()};a.LiteralDecoder.prototype.getDecoder=function(a,
c){return this._coders[((a&this._posMask)<<this._numPrevBits)+((c&255)>>>8-this._numPrevBits)]};a.Decoder=function(){this._outWindow=new a.OutWindow;this._rangeDecoder=new a.RangeDecoder;this._isMatchDecoders=[];this._isRepDecoders=[];this._isRepG0Decoders=[];this._isRepG1Decoders=[];this._isRepG2Decoders=[];this._isRep0LongDecoders=[];this._posSlotDecoder=[];this._posDecoders=[];this._posAlignDecoder=new a.BitTreeDecoder(4);this._lenDecoder=new a.LenDecoder;this._repLenDecoder=new a.LenDecoder;this._literalDecoder=
new a.LiteralDecoder;this._dictionarySizeCheck=this._dictionarySize=-1;this._posSlotDecoder[0]=new a.BitTreeDecoder(6);this._posSlotDecoder[1]=new a.BitTreeDecoder(6);this._posSlotDecoder[2]=new a.BitTreeDecoder(6);this._posSlotDecoder[3]=new a.BitTreeDecoder(6)};a.Decoder.prototype.setDictionarySize=function(a){if(0>a)return!1;this._dictionarySize!==a&&(this._dictionarySize=a,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096)));
return!0};a.Decoder.prototype.setLcLpPb=function(a,c,e){var b=1<<e;if(8<a||4<c||4<e)return!1;this._literalDecoder.create(c,a);this._lenDecoder.create(b);this._repLenDecoder.create(b);this._posStateMask=b-1;return!0};a.Decoder.prototype.init=function(){var b=4;this._outWindow.init(!1);a.initBitModels(this._isMatchDecoders,192);a.initBitModels(this._isRep0LongDecoders,192);a.initBitModels(this._isRepDecoders,12);a.initBitModels(this._isRepG0Decoders,12);a.initBitModels(this._isRepG1Decoders,12);a.initBitModels(this._isRepG2Decoders,
12);a.initBitModels(this._posDecoders,114);for(this._literalDecoder.init();b--;)this._posSlotDecoder[b].init();this._lenDecoder.init();this._repLenDecoder.init();this._posAlignDecoder.init();this._rangeDecoder.init()};a.Decoder.prototype.decode=function(b,c,e){var d=0,f=0,g=0,k=0,m=0,q=0,n=0;this._rangeDecoder.setStream(b);this._outWindow.setStream(c);for(this.init();0>e||q<e;)if(b=q&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(d<<4)+b))n=this._literalDecoder.getDecoder(q++,
n),n=7<=d?n.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(f)):n.decodeNormal(this._rangeDecoder),this._outWindow.putByte(n),d=4>d?0:d-(10>d?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,d))n=0,0===this._rangeDecoder.decodeBit(this._isRepG0Decoders,d)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(d<<4)+b)&&(d=7>d?9:11,n=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,d)?c=g:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,d)?c=k:(c=
m,m=k),k=g),g=f,f=c),0===n&&(n=2+this._repLenDecoder.decode(this._rangeDecoder,b),d=7>d?8:11);else if(m=k,k=g,g=f,n=2+this._lenDecoder.decode(this._rangeDecoder,b),d=7>d?7:10,b=this._posSlotDecoder[5>=n?n-2:3].decode(this._rangeDecoder),4<=b)if(c=(b>>1)-1,f=(2|b&1)<<c,14>b)f+=a.reverseDecode2(this._posDecoders,f-b-1,this._rangeDecoder,c);else{if(f+=this._rangeDecoder.decodeDirectBits(c-4)<<4,f+=this._posAlignDecoder.reverseDecode(this._rangeDecoder),0>f){if(-1===f)break;return!1}}else f=b;if(f>=q||
f>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(f,n);q+=n;n=this._outWindow.getByte(0)}this._outWindow.flush();this._outWindow.releaseStream();this._rangeDecoder.releaseStream();return!0};a.Decoder.prototype.setDecoderProperties=function(a){if(5>a.size)return!1;var b=a.readByte();var e=b%9;b=~~(b/9);if(!this.setLcLpPb(e,b%5,~~(b/5)))return!1;b=a.readByte();b|=a.readByte()<<8;b|=a.readByte()<<16;b+=16777216*a.readByte();return this.setDictionarySize(b)};a.decompress=function(b,c,e,
d){var f=new a.Decoder;if(!f.setDecoderProperties(b))throw"Incorrect stream properties";if(!f.decode(c,e,d))throw"Error in data stream";return!0};a.decompressFile=function(b,c){var e=new a.Decoder;if(!e.setDecoderProperties(b))throw"Incorrect stream properties";var d=b.readByte();d|=b.readByte()<<8;d|=b.readByte()<<16;d+=16777216*b.readByte();b.readByte();b.readByte();b.readByte();b.readByte();if(!e.decode(b,c,d))throw"Error in data stream";return!0};return a}();g.engine=function(){var a="LZMA",b,
c,f=null,d=window.URL||window.webkitURL,v="undefined"===typeof performance?Date:performance,h=0,k=0,m=0,A=0,n=0,r=0,t=0,p,x=null,y=null,z=!1,w=!1,l=!1,u="",I="",E=.5*Math.PI,F,G,B,J,K,S,T,U,L=null,O=null,M="free",N=[],P=[],R="",H=!1,C={worldscale:1,gravity:[0,-10,0],fps:60,substep:2,broadphase:2,soft:!0,animFrame:!0,fixed:!0,jointDebug:!1};g.engine={folder:"./build/",message:function(a){a=a.data;a.Ar&&(e.Ar=a.Ar);a.flow&&(e.flow=a.flow);switch(a.m){case "initEngine":g.engine.initEngine();break;case "start":g.engine.start();
break;case "step":g.engine.step(a.fps,a.delta);break;case "moveSolid":g.engine.moveSolid(a.o);break;case "ellipsoid":g.engine.ellipsoidMesh(a.o);break;case "makeBreak":g.engine.makeBreak(a.o)}},init:function(b,e,d,h){this.initArray(h);this.defaultRoot();d=d||{};c=b;H=d.use_intern_update||!1;C={fps:d.fps||60,worldscale:d.worldscale||1,gravity:d.gravity||[0,-10,0],substep:d.substep||2,broadphase:d.broadphase||2,soft:void 0!==d.soft?d.soft:!0,fixed:void 0!==d.fixed?d.fixed:!0,animFrame:void 0!==d.animFrame?
d.animFrame:!0,jointDebug:void 0!==d.jointDebug?d.jointDebug:!1,isInternUpdate:H};t=1/C.fps*1E3;a=e||"LZMA";switch(a){case "min":g.engine.load(g.engine.folder+"ammo.hex",!0);break;case "LZMA":case "lzma":case "compact":g.engine.load(g.engine.folder+"ammo.hex");break;case "WASM":case "wasm":f=document.location.href.replace(/\/[^/]*$/,"/")+g.engine.folder+"ammo.wasm.js";g.engine.startWorker();break;case "BASIC":case "basic":f=document.location.href.replace(/\/[^/]*$/,"/")+g.engine.folder+"ammo.js",
g.engine.startWorker()}},set:function(a){a=a||C;t=void 0!==a.fps?1/a.fps*1E3:t;C.fixed=a.fixed||!1;C.animFrame=a.animFrame||!1;C.jointDebug=a.jointDebug||!1;a.isInternUpdate=H;e.constraintDebug=C.jointDebug;this.post("set",a)},load:function(a,b){var c=new XMLHttpRequest;c.responseType="arraybuffer";c.open("GET",a,!0);c.onreadystatechange=function(){4===c.readyState&&(200===c.status||0===c.status?(f=d.createObjectURL(new Blob([ka(c.response)],{type:"application/javascript"})),g.engine.startWorker(b)):
console.error("Couldn't load ["+a+"] ["+c.status+"]"))};c.send(null)},startWorker:function(a){b=new Worker(g.engine.folder+(a?"gun.min.js":"gun.js"));b.postMessage=b.webkitPostMessage||b.postMessage;b.onmessage=g.engine.message;a=new ArrayBuffer(1);b.postMessage({m:"test",ab:a},[a]);z=a.byteLength?!1:!0;H&&(z=!1);g.engine.post("init",{blob:f,ArPos:e.ArPos,ArMax:e.ArMax,isBuffer:z,option:C});e.post=g.engine.post},initArray:function(a){a=a||{};e.ArLng=[8*(a.maxBody||1400),a.maxContact||200,8*(a.maxCharacter||
10),64*(a.maxCar||14),3*(a.maxSoftPoint||8192),14*(a.maxJoint||1E3)];e.ArPos=[0,e.ArLng[0],e.ArLng[0]+e.ArLng[1],e.ArLng[0]+e.ArLng[1]+e.ArLng[2],e.ArLng[0]+e.ArLng[1]+e.ArLng[2]+e.ArLng[3],e.ArLng[0]+e.ArLng[1]+e.ArLng[2]+e.ArLng[3]+e.ArLng[4]];e.ArMax=e.ArLng[0]+e.ArLng[1]+e.ArLng[2]+e.ArLng[3]+e.ArLng[4]+e.ArLng[5]},initEngine:function(){d.revokeObjectURL(f);f=null;this.initObject();console.log("SHOTGUN 005 | "+(z?"buffer":"no buffer")+" | "+a);c&&c()},start:function(a){w||(g.engine.stop(),l=!0,
z&&(e.Ar=new Float32Array(e.ArMax)),m=v.now(),a||H||(x=C.animFrame?requestAnimationFrame(g.engine.sendData):setInterval(function(){g.engine.sendData()},t)),!a&&H&&(a=g.engine.getKey(),b.postMessage({m:"internStep",o:{steptime:0,key:a},flow:e.flow,Ar:e.Ar})),g.engine.setMode(I))},prevUpdate:function(){},postUpdate:function(){},pastUpdate:function(){},update:function(){g.engine.postUpdate(k);F.step(e.Ar,e.ArPos[0]);S.step(e.Ar,e.ArPos[1]);K.step(e.Ar,e.ArPos[2]);J.step(e.Ar,e.ArPos[3]);G.step(e.Ar,
e.ArPos[4]);U.step(e.Ar,e.ArPos[5]);B.step();T.step();g.engine.pastUpdate(k)},step:function(a,b){H?(p=a,k=b):(h-1E3>n&&(n=h,p=r,r=0),r++);g.engine.tell();g.engine.update();e.controler&&e.controler.follow();g.engine.stepRemove();g.engine.stepAdd();l=!0;H&&g.engine.sendStep()},sendData:function(a){H||(y&&y.pause?g.engine.stop():C.animFrame?(x=requestAnimationFrame(g.engine.sendData),h=void 0===a?v.now():a,A=h-m,k=.001*A,A>t&&(m=h-A%t,g.engine.sendStep())):l&&(k=.001*(h-m),m=h,g.engine.sendStep()))},
sendStep:function(){if(l){h=v.now();g.engine.prevUpdate(k);var a=g.engine.getKey();H?z&&b.postMessage({m:"internStep",o:{steptime:0,key:a},flow:e.flow,Ar:e.Ar},[e.Ar.buffer]):z?b.postMessage({m:"step",o:{delta:k,key:a},flow:e.flow,Ar:e.Ar},[e.Ar.buffer]):b.postMessage({m:"step",o:{delta:k,key:a},flow:e.flow,Ar:e.Ar});l=!1}},simpleStep:function(a){var c=g.engine.getKey();b.postMessage({m:"step",o:{delta:a,key:c}})},stepRemove:function(){if(0!==N.length)for(this.post("setRemove",N);0<N.length;)this.remove(N.pop(),
!0)},stepAdd:function(){if(0!==P.length)for(;0<P.length;)this.add(P.shift())},setView:function(a){y=a;e.mat=Object.assign({},e.mat,a.getMat());e.geo=Object.assign({},e.geo,a.getGeo());e.container=a.getContent();e.controler=a.getControler();e.isRefView=!0},getFps:function(){return p},getDelta:function(){return k},getIsFixed:function(){return C.fixed},getKey:function(){return[0,0,0,0,0,0,0,0]},tell:function(){},log:function(){},post:function(a,c){b.postMessage({m:a,o:c})},reset:function(a){g.engine.postUpdate=
function(){};g.engine.pastUpdate=function(){};g.engine.prevUpdate=function(){};w=!1;I=u;g.engine.setMode("");g.engine.stop();for(g.engine.clear();0<e.tmpMat.length;)e.tmpMat.pop().dispose();N=[];P=[];R="";y&&y.reset(a);g.engine.post("reset",{full:a})},pause:function(){w=!0},play:function(){w&&(w=!1,g.engine.start())},stop:function(){null!==x&&(C.animFrame?window.cancelAnimationFrame(x):clearInterval(x),x=null)},destroy:function(){b.terminate();b=void 0},addMat:function(a){e.tmpMat.push(a)},ellipsoidMesh:function(a){G.createEllipsoid(a)},
updateTmpMat:function(a,b){for(var c=e.tmpMat.length,d;c--;)d=e.tmpMat[c],void 0!==d.envMap&&(d.envMap="MeshStandardMaterial"===d.type?a:b?null:a,d.needsUpdate=!0)},setVehicle:function(a){e.flow.vehicle.push(a)},drive:function(a){this.post("setDrive",a)},move:function(a){this.post("setMove",a)},forces:function(a,b){g.engine.post(b?"directForces":"setForces",a)},options:function(a,b){g.engine.post(b?"directOptions":"setOptions",a)},matrix:function(a,b){g.engine.post(b?"directMatrix":"setMatrix",a)},
clearFlow:function(){e.flow={ray:[],terrain:[],vehicle:[]}},anchor:function(a){this.post("addAnchor",a)},break:function(a){this.post("addBreakable",a)},moveSolid:function(a){if(q.has(a.name)){var b=q.get(a.name);void 0!==a.pos&&b.position.fromArray(a.pos);void 0!==a.quat&&b.quaternion.fromArray(a.quat)}},getBodys:function(){return F.bodys},initObject:function(){F=new W;G=new Z;B=new ba;J=new ca;K=new da;S=new ea;T=new ha;U=new X},clear:function(){g.engine.clearFlow();F.clear();S.clear();B.clear();
J.clear();K.clear();G.clear();T.clear();for(U.clear();0<e.extraGeo.length;)e.extraGeo.pop().dispose()},remove:function(a,b){b||this.post("remove",a);b=g.engine.byName(a);if(null!==b)switch(b.type){case "solid":case "body":F.remove(a);break;case "soft":G.remove(a);break;case "terrain":B.remove(a);break;case "collision":S.remove(a);break;case "ray":T.remove(a);break;case "constraint":U.remove(a)}},removes:function(a){N=N.concat(a)},removesDirect:function(a){this.post("directRemoves",a)},byName:function(a){if(q.has(a))return q.get(a);
g.engine.tell("no find object !!");return null},addGroup:function(a){P=P.concat(a)},add:function(a){a=a||{};var b=void 0===a.type?"box":a.type,c=b.substring(0,4);if("join"===c)return U.add(a);if("soft"===c)G.add(a);else if("terrain"===b)B.add(a);else{if("character"===b)return K.add(a);if("collision"===b)return S.add(a);if("car"===b)J.add(a);else return"ray"===b?T.add(a):F.add(a)}},defaultRoot:function(){var a={circle:new THREE.CircleBufferGeometry(1,6),plane:new THREE.PlaneBufferGeometry(1,1,1,1),
box:new THREE.BoxBufferGeometry(1,1,1),hardbox:new THREE.BoxBufferGeometry(1,1,1),cone:new THREE.CylinderBufferGeometry(0,1,.5),wheel:new THREE.CylinderBufferGeometry(1,1,1,18),sphere:new THREE.SphereBufferGeometry(1,16,12),highsphere:new THREE.SphereBufferGeometry(1,32,24),cylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1),hardcylinder:new THREE.CylinderBufferGeometry(1,1,1,12,1),joint:new THREE.ConeBufferGeometry(.1,.2,4)};a.circle.rotateX(-E);a.plane.rotateX(-E);a.wheel.rotateZ(-E);a.joint.translate(0,
.1,0);a.joint.rotateZ(.5*-Math.PI);e.geo=a;e.mat={hide:new THREE.MeshBasicMaterial({name:"debug",color:0,depthTest:!1,depthWrite:!1,visible:!1}),move:new THREE.MeshLambertMaterial({color:13421772,name:"move",wireframe:!1,shadowSide:!1}),speed:new THREE.MeshLambertMaterial({color:16763955,name:"speed",wireframe:!1,shadowSide:!1}),sleep:new THREE.MeshLambertMaterial({color:3394815,name:"sleep",wireframe:!1,shadowSide:!1}),static:new THREE.MeshLambertMaterial({color:3355443,name:"static",wireframe:!1,
shadowSide:!1,transparent:!0,opacity:.3,depthTest:!0,depthWrite:!1}),kinematic:new THREE.MeshLambertMaterial({color:8978227,name:"kinematic",wireframe:!1,shadowSide:!1}),soft:new THREE.MeshLambertMaterial({name:"soft",vertexColors:THREE.VertexColors,shadowSide:!1}),debug:new THREE.MeshBasicMaterial({name:"debug",color:65280,depthTest:!1,depthWrite:!1,wireframe:!0,shadowSide:!1}),jointLine:new THREE.LineBasicMaterial({name:"jointLine",vertexColors:THREE.VertexColors,depthTest:!1,depthWrite:!1,transparent:!0}),
jointP1:new THREE.MeshBasicMaterial({name:"jointP1",color:65280,depthTest:!1,depthWrite:!0,wireframe:!0}),jointP2:new THREE.MeshBasicMaterial({name:"jointP2",color:16776960,depthTest:!1,depthWrite:!0,wireframe:!0})};e.container=new THREE.Group;e.destroy=function(a){for(var b;0<a.children.length;){for(b=a.children.pop();0<b.children.length;)b.remove(b.children.pop());a.remove(b)}a.parent&&a.parent.remove(a)}},getContainer:function(){return e.container},makeBreak:function(a){var b=a.name;if(q.has(b)){null===
L&&(L=new D);var c=q.get(b),d=a.breakOption;a=L.subdivideByImpact(c,a.pos,a.normal,d[1],d[2]);--d[3];N.push(b);for(c=a.length;c--;)P.push(this.addDebris(b,c,a[c],d))}},addDebris:function(a,b,c,d){a={name:a+"_debris"+b,material:c.material,type:"convex",shape:c.geometry,pos:c.position.toArray(),quat:c.quaternion.toArray(),mass:c.userData.mass,linearVelocity:c.userData.velocity.toArray(),angularVelocity:c.userData.angularVelocity.toArray(),margin:.05};0<d[3]&&(a.breakable=!0,a.breakOption=d);return a},
setMode:function(a){a!==u&&("picker"===u&&g.engine.removeRayCamera(),"shoot"===u&&g.engine.removeShootCamera(),"lock"===u&&g.engine.removeLockCamera());u=a;"picker"===u&&g.engine.addRayCamera();"shoot"===u&&g.engine.addShootCamera();"lock"===u&&g.engine.addLockCamera()},addLockCamera:function(){},removeLockCamera:function(){},addShootCamera:function(){},removeShootCamera:function(){},addRayCamera:function(){y&&(O=g.engine.add({name:"cameraRay",type:"ray",callback:g.engine.onRay,mask:1,visible:!1}),
y.activeRay(g.engine.updateRayCamera,!1))},removeRayCamera:function(){y&&(g.engine.remove("cameraRay"),y.removeRay(),g.engine.log())},updateRayCamera:function(a){"drag"===M&&g.engine.matrix([{name:"dragger",pos:a.toArray(),keepRot:!0}])},onRay:function(a){var b=y.getMouse(),c=y.getControls(),d=void 0===a.name?"":a.name;O.setFromCamera(b,c.object);0===b.z?("drag"===M&&(c.enableRotate=!0,g.engine.removeConnector()),M="free"):"free"===M&&(d?"drag"!==M&&(y.setDragPlane(a.point),c.enableRotate=!1,g.engine.addConnector(a),
M="drag"):M="rotate");g.engine.log(M+"   "+d)},addConnector:function(a){var b=g.engine.byName(a.name);if(null!==b){g.engine.testCurrentFollow(a.name);var c=(new THREE.Vector3).fromArray(a.point),d=b.quaternion.toArray();b=g.engine.getLocalPoint(c,b).toArray();g.engine.add({name:"dragger",type:"sphere",size:[.2],pos:a.point,quat:d,mass:0,kinematic:!0,group:32,mask:32});g.engine.add({name:"connector",type:"joint_fixe",b1:"dragger",b2:a.name,pos1:[0,0,0],pos2:b,collision:!1})}},removeConnector:function(){g.engine.remove("dragger");
g.engine.remove("connector");""!==R&&g.engine.setCurrentFollow(R)},getLocalPoint:function(a,b){b.updateMatrix();var c=new THREE.Matrix4,d=new THREE.Vector3(1,1,1);b=(new THREE.Matrix4).compose(b.position,b.quaternion,d);c.getInverse(b);return a.applyMatrix4(c)},setCurrentFollow:function(a,b){y&&(a=g.engine.byName(a),null!==a?y.getControls().initFollow(a,b):y.getControls().resetFollow(),R="")},testCurrentFollow:function(a){R="";y&&y.getControls().followTarget&&y.getControls().followTarget.name===a&&
(y.getControls().resetFollow(),R=a)}};return g.engine}();Object.defineProperty(g,"__esModule",{value:!0})});
